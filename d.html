<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Secure PDF Viewer</title>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF.js Lib -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        :root {
            --bg-color: #525659;
            --toolbar-bg: #323639;
            --text-color: #f1f1f1;
            --shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--bg-color);
            font-family: 'Roboto', sans-serif;
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Toolbar Styles */
        #toolbar {
            height: 56px;
            background-color: var(--toolbar-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: var(--shadow);
            z-index: 100;
        }

        .toolbar-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn {
            background: transparent;
            border: none;
            color: #dcdcdc;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: 0.2s;
            font-size: 16px;
        }

        .btn:hover {
            background-color: rgba(255,255,255,0.1);
            color: #fff;
        }

        .page-info {
            background: #202124;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #page_num {
            background: transparent;
            border: none;
            color: white;
            width: 30px;
            text-align: center;
            font-weight: bold;
        }
        
        #page_num:focus { outline: none; border-bottom: 1px solid #8ab4f8; }

        /* Viewer Container */
        #viewer-container {
            flex: 1;
            overflow: auto;
            position: relative;
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        #canvas-wrapper {
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }

        /* Loading Spinner */
        #loader {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.1);
            border-left-color: #8ab4f8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        .loading-text { margin-top: 15px; font-size: 14px; color: #aaa; }

        /* Toast Notification */
        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #323232;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 300;
        }

        #toast.show { opacity: 1; }

        /* Responsive */
        @media (max-width: 600px) {
            .hide-mobile { display: none; }
            #toolbar { padding: 0 10px; }
        }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loader">
        <div class="spinner"></div>
        <div class="loading-text" id="loading-msg">Initializing Secure Viewer...</div>
    </div>

    <!-- Toolbar -->
    <div id="toolbar">
        <div class="toolbar-section">
            <button class="btn" id="prev" title="Previous Page"><i class="fas fa-arrow-up"></i></button>
            <div class="page-info">
                <input type="number" id="page_num" value="1">
                <span> / <span id="page_count">--</span></span>
            </div>
            <button class="btn" id="next" title="Next Page"><i class="fas fa-arrow-down"></i></button>
        </div>

        <div class="toolbar-section">
            <button class="btn" id="zoom_out" title="Zoom Out"><i class="fas fa-minus"></i></button>
            <button class="btn" id="zoom_in" title="Zoom In"><i class="fas fa-plus"></i></button>
        </div>

        <div class="toolbar-section">
            <button class="btn" id="share_btn" title="Copy Secure Link"><i class="fas fa-link"></i></button>
        </div>
    </div>

    <!-- PDF Canvas -->
    <div id="viewer-container">
        <div id="canvas-wrapper">
            <canvas id="the-canvas"></canvas>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast">Link Copied!</div>

    <!-- Application Logic -->
    <script type="module">
        // ---------------------------------------------------------
        // 1. FIREBASE SETUP
        // ---------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDL7sPp-FkG59L-mRQ7BrCGgeKMhQC80iw",
            authDomain: "xperts-metadata.firebaseapp.com",
            projectId: "xperts-metadata",
            storageBucket: "xperts-metadata.firebasestorage.app",
            messagingSenderId: "514845910910",
            appId: "1:514845910910:web:5a2402130a97b5d749b52f",
            measurementId: "G-CQ5KWGJSZB"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const COLLECTION_NAME = "pdf_shares";

        // ---------------------------------------------------------
        // 2. STATE & HELPER FUNCTIONS
        // ---------------------------------------------------------
        const state = {
            pdfDoc: null,
            pageNum: 1,
            pageRendering: false,
            pageNumPending: null,
            scale: 1.2,
            canvas: document.getElementById('the-canvas'),
            ctx: document.getElementById('the-canvas').getContext('2d'),
            loader: document.getElementById('loader'),
            msg: document.getElementById('loading-msg')
        };

        // Generate 15 digit alphanumeric code
        const generateCode = () => {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 15; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        };

        const showToast = (message) => {
            const toast = document.getElementById('toast');
            toast.innerText = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        };

        // ---------------------------------------------------------
        // 3. MAIN LOGIC (URL Handling & Database)
        // ---------------------------------------------------------
        async function init() {
            const params = new URLSearchParams(window.location.search);
            const fileUrl = params.get('file');
            const code = params.get('code');

            if (code) {
                // Scenario 1: User has a code
                state.msg.innerText = "Retrieving Document...";
                await loadPdfByCode(code);
            } else if (fileUrl) {
                // Scenario 2: User provided a raw URL (needs masking)
                state.msg.innerText = "Securing Document...";
                await handleRawUrl(fileUrl);
            } else {
                state.msg.innerText = "No file specified.";
                state.loader.querySelector('.spinner').style.display = 'none';
            }
        }

        async function handleRawUrl(url) {
            try {
                // 1. Check if URL already exists in DB
                const q = query(collection(db, COLLECTION_NAME), where("originalUrl", "==", url));
                const querySnapshot = await getDocs(q);

                let secureCode;

                if (!querySnapshot.empty) {
                    // Exists: Use existing code
                    secureCode = querySnapshot.docs[0].data().code;
                    console.log("Found existing code:", secureCode);
                } else {
                    // New: Generate and Save
                    secureCode = generateCode();
                    await addDoc(collection(db, COLLECTION_NAME), {
                        code: secureCode,
                        originalUrl: url,
                        createdAt: new Date()
                    });
                    console.log("Generated new code:", secureCode);
                }

                // 2. Change URL in address bar without reload
                const newUrl = `${window.location.pathname}?code=${secureCode}`;
                window.history.replaceState({ path: newUrl }, '', newUrl);

                // 3. Load PDF
                loadPdf(url);

            } catch (error) {
                console.error("Database Error:", error);
                state.msg.innerText = "Error securing link. Check console.";
            }
        }

        async function loadPdfByCode(code) {
            try {
                const q = query(collection(db, COLLECTION_NAME), where("code", "==", code));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const url = querySnapshot.docs[0].data().originalUrl;
                    loadPdf(url);
                } else {
                    state.msg.innerText = "Invalid or Expired Code.";
                    state.loader.querySelector('.spinner').style.display = 'none';
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                state.msg.innerText = "Error fetching document.";
            }
        }

        // ---------------------------------------------------------
        // 4. PDF RENDERING (PDF.js)
        // ---------------------------------------------------------
        function loadPdf(url) {
            state.msg.innerText = "Rendering PDF...";
            
            pdfjsLib.getDocument(url).promise.then(function(pdfDoc_) {
                state.pdfDoc = pdfDoc_;
                document.getElementById('page_count').textContent = state.pdfDoc.numPages;

                // Initial render
                renderPage(state.pageNum);
                
                // Hide loader
                state.loader.style.display = 'none';
            }).catch(function(error) {
                console.error(error);
                state.msg.innerText = "Failed to load PDF. Possible CORS issue.";
                state.loader.querySelector('.spinner').style.borderLeftColor = 'red';
            });
        }

        function renderPage(num) {
            state.pageRendering = true;
            
            // Fetch page
            state.pdfDoc.getPage(num).then(function(page) {
                const viewport = page.getViewport({scale: state.scale});
                state.canvas.height = viewport.height;
                state.canvas.width = viewport.width;

                const renderContext = {
                    canvasContext: state.ctx,
                    viewport: viewport
                };
                
                const renderTask = page.render(renderContext);

                // Wait for render to finish
                renderTask.promise.then(function() {
                    state.pageRendering = false;
                    if (state.pageNumPending !== null) {
                        renderPage(state.pageNumPending);
                        state.pageNumPending = null;
                    }
                });
            });

            // Update page counters
            document.getElementById('page_num').value = num;
        }

        function queueRenderPage(num) {
            if (state.pageRendering) {
                state.pageNumPending = num;
            } else {
                renderPage(num);
            }
        }

        function onPrevPage() {
            if (state.pageNum <= 1) return;
            state.pageNum--;
            queueRenderPage(state.pageNum);
        }

        function onNextPage() {
            if (state.pageNum >= state.pdfDoc.numPages) return;
            state.pageNum++;
            queueRenderPage(state.pageNum);
        }

        function onZoomIn() {
            state.scale += 0.2;
            queueRenderPage(state.pageNum);
        }

        function onZoomOut() {
            if(state.scale <= 0.6) return;
            state.scale -= 0.2;
            queueRenderPage(state.pageNum);
        }

        // ---------------------------------------------------------
        // 5. EVENT LISTENERS
        // ---------------------------------------------------------
        document.getElementById('prev').addEventListener('click', onPrevPage);
        document.getElementById('next').addEventListener('click', onNextPage);
        document.getElementById('zoom_in').addEventListener('click', onZoomIn);
        document.getElementById('zoom_out').addEventListener('click', onZoomOut);
        
        document.getElementById('page_num').addEventListener('change', function(e) {
            let num = parseInt(this.value);
            if(num > 0 && num <= state.pdfDoc.numPages) {
                state.pageNum = num;
                queueRenderPage(num);
            }
        });

        document.getElementById('share_btn').addEventListener('click', () => {
            navigator.clipboard.writeText(window.location.href).then(() => {
                showToast("Secure Link Copied!");
            });
        });

        // Start App
        window.onload = init;

    </script>
</body>
</html>
