<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Editor</title>
    <style>
        :root { --primary: #6366f1; --bg: #f8fafc; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); padding: 20px; display: flex; justify-content: center; }
        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); width: 100%; max-width: 500px; }
        h2 { margin-top: 0; color: #1e293b; font-size: 1.5rem; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; margin-bottom: 20px; }
        .field-box { margin-bottom: 15px; }
        label { display: block; font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 5px; }
        input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 1rem; transition: all 0.2s; }
        input:focus { outline: none; border-color: var(--primary); ring: 2px solid #e0e7ff; }
        button { width: 100%; background: var(--primary); color: white; border: none; padding: 14px; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        button:hover { opacity: 0.9; }
        #loader { text-align: center; color: #64748b; padding: 40px; }
        .error-msg { color: #ef4444; background: #fef2f2; padding: 15px; border-radius: 8px; text-align: center; }
    </style>
</head>
<body>

<div class="card">
    <h2 id="formTitle">Edit Details</h2>
    <div id="statusContainer">
        <div id="loader">Fetching record...</div>
    </div>

    <form id="dynamicForm" style="display:none">
        <div id="inputsContainer"></div>
        <button type="submit" id="saveBtn">Save Changes</button>
    </form>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDPm2za3Ho0Hd8Henuhq0KxAHyUQh-Hi-U",
        authDomain: "question-metabase.firebaseapp.com",
        projectId: "question-metabase",
        storageBucket: "question-metabase.firebasestorage.app",
        messagingSenderId: "770698198753",
        appId: "1:770698198753:web:59ae49d78b6013bab5c1a0"
    };

    // 1. Configuration Map (Links URL params to Database Paths)
    const FIELD_MAP = {
        "area": { path: "address.area", label: "Area/Street" },
        "city": { path: "address.city", label: "City" },
        "house": { path: "address.house", label: "House No/Name" },
        "pincode": { path: "address.pincode", label: "Pincode" },
        "phone": { path: "contact.phone", label: "Phone Number" },
        "name": { path: "personal.name", label: "Full Name" },
        "dob": { path: "personal.dob", label: "Date of Birth" },
        "pan": { path: "documents.pan", label: "PAN Card" },
        "aadhaar": { path: "generatedAadhaar", label: "Aadhaar Number" }
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const params = new URLSearchParams(window.location.search);
    const idValue = params.get('id');
    const editRequested = params.get('edit') || "all";
    
    let internalDocId = null;

    if (!idValue) {
        showError("Missing 'id' parameter in URL.");
    } else {
        init();
    }

    async function init() {
        try {
            // Find the document by Aadhaar or Phone
            const colRef = collection(db, "MyAadhaar");
            let q = query(colRef, where("generatedAadhaar", "==", idValue));
            let snap = await getDocs(q);

            if (snap.empty) {
                q = query(colRef, where("contact.phone", "==", idValue));
                snap = await getDocs(q);
            }

            if (!snap.empty) {
                const userDoc = snap.docs[0];
                internalDocId = userDoc.id;
                renderForm(userDoc.data());
            } else {
                showError("Record not found.");
            }
        } catch (e) {
            showError("Database Error: " + e.message);
        }
    }

    function renderForm(data) {
        const container = document.getElementById('inputsContainer');
        const editList = editRequested.split(',');

        // Determine which fields to show
        Object.keys(FIELD_MAP).forEach(key => {
            if (editRequested === 'all' || editList.includes(key)) {
                const config = FIELD_MAP[key];
                
                // Extract value from nested object (e.g., data.address.city)
                const val = config.path.split('.').reduce((o, i) => o ? o[i] : '', data);

                const div = document.createElement('div');
                div.className = 'field-box';
                div.innerHTML = `
                    <label>${config.label}</label>
                    <input type="text" data-path="${config.path}" value="${val || ''}">
                `;
                container.appendChild(div);
            }
        });

        document.getElementById('statusContainer').style.display = 'none';
        document.getElementById('dynamicForm').style.display = 'block';
    }

    document.getElementById('dynamicForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('saveBtn');
        btn.innerText = "Updating...";
        btn.disabled = true;

        const updates = {};
        const allInputs = document.querySelectorAll('#inputsContainer input');
        
        allInputs.forEach(input => {
            updates[input.dataset.path] = input.value;
        });

        try {
            await updateDoc(doc(db, "MyAadhaar", internalDocId), updates);
            alert("Updated successfully!");
            location.reload();
        } catch (err) {
            alert("Error: " + err.message);
            btn.disabled = false;
            btn.innerText = "Save Changes";
        }
    };

    function showError(msg) {
        document.getElementById('statusContainer').innerHTML = `<div class="error-msg">${msg}</div>`;
    }
</script>

</body>
</html>
