<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trigger - MailSystem</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background: #f4f4f4; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <div class="card">
        <h2 id="status">Processing System Trigger...</h2>
        <p id="details">Please wait while we route your message.</p>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDPm2za3Ho0Hd8Henuhq0KxAHyUQh-Hi-U",
            authDomain: "question-metabase.firebaseapp.com",
            databaseURL: "https://question-metabase-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "question-metabase",
            storageBucket: "question-metabase.firebasestorage.app",
            messagingSenderId: "770698198753",
            appId: "1:770698198753:web:59ae49d78b6013bab5c1a0",
            measurementId: "G-6ZP1FPMKSJ"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // EmailJS Init
        emailjs.init("Yr9MutUoHOEONnFgn");

        async function processTrigger() {
            const statusEl = document.getElementById('status');
            const detailsEl = document.getElementById('details');

            // 1. Get Normal Text from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const rawR = urlParams.get('r'); // Receiver
            const rawS = urlParams.get('s'); // Secret Key
            const rawM = urlParams.get('m'); // Message

            if(!rawR || !rawS || !rawM) {
                statusEl.innerText = "Error";
                statusEl.className = "error";
                detailsEl.innerText = "Missing parameters in URL (r, s, or m).";
                return;
            }

            // 2. IMMEDIATELY ENCRYPT (Base64)
            const encR = btoa(rawR);
            const encS = btoa(rawS);
            const encM = btoa(rawM);

            // Hide the plain text from the address bar immediately for security
            window.history.replaceState({}, document.title, `5.html?process=${encS.substring(0,10)}`);

            try {
                // 3. Verify Secret Key (We use the rawS to query the DB)
                const keyDoc = await db.collection("api_keys").doc(rawS).get();
                if (!keyDoc.exists) {
                    throw new Error("Unauthorized: Invalid Company Secret Key.");
                }
                const company = keyDoc.data().companyName;

                // 4. Check if Receiver is in our database
                const userQuery = await db.collection("users").where("email", "==", rawR).get();

                if (!userQuery.empty) {
                    // USER EXISTS -> Store data in Firestore Emails
                    await db.collection("emails").add({
                        sender: company,
                        receiver: rawR,
                        subject: "API System Alert",
                        message: rawM, // You can store the raw or encM here
                        status: 'inbox',
                        timestamp: Date.now(),
                        encrypted_ref: encM // Storing the encrypted version as a ref
                    });
                    statusEl.innerText = "Success";
                    statusEl.className = "success";
                    detailsEl.innerText = "Message delivered to internal user inbox.";
                } else {
                    // USER NOT IN DATA -> Use EmailJS
                    await emailjs.send("service_qiyll9e", "template_vssk4uu", {
                        to_email: rawR,
                        from_name: company,
                        message: rawM,
                        subject: "External System Notification"
                    });
                    statusEl.innerText = "Success";
                    statusEl.className = "success";
                    detailsEl.innerText = "User not found in system. Message sent via EmailJS service.";
                }

            } catch (err) {
                statusEl.innerText = "Trigger Failed";
                statusEl.className = "error";
                detailsEl.innerText = err.message;
            }
        }

        window.onload = processTrigger;
    </script>
</body>
</html>
