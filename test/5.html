<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Processing...</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>
<body style="font-family:sans-serif; text-align:center; padding-top:50px;">
    <h2 id="status">Verifying Request...</h2>

    <script>
        firebase.initializeApp({ apiKey: "AIzaSyDPm2za3Ho0Hd8Henuhq0KxAHyUQh-Hi-U", projectId: "question-metabase" });
        const db = firebase.firestore();
        emailjs.init("Yr9MutUoHOONnFgn");

        async function process() {
            const params = new URLSearchParams(window.location.search);
            const r = params.get('r'); // Receiver
            const s = params.get('s'); // Secret Key
            const m = params.get('m'); // Message/Code
            const t = params.get('t'); // Template ID

            // ENCRYPT & HIDE PARAMS IMMEDIATELY
            const enc = btoa(`r=${r}&s=${s}&m=${m}`);
            window.history.replaceState({}, '', '5.html?session=' + enc.substring(0,10));

            try {
                const keyDoc = await db.collection("api_keys").doc(s).get();
                const tempDoc = await db.collection("templates").doc(t).get();

                if(!keyDoc.exists || !tempDoc.exists) throw new Error("Invalid Auth or Template");

                const company = keyDoc.data().companyName;
                const templateData = tempDoc.data();
                
                // Process HTML: Replace {{code}} with parameter m
                const finalHtml = templateData.html.replace(/{{code}}/g, m);

                // Check for Internal User
                const userDoc = await db.collection("users").doc(r).get();

                if(userDoc.exists) {
                    await db.collection("emails").add({
                        sender: company,
                        receiver: r,
                        subject: templateData.subject, // CUSTOM SUBJECT
                        message: finalHtml,
                        status: 'inbox',
                        timestamp: Date.now()
                    });
                    document.getElementById('status').innerText = "Delivered Internally.";
                } else {
                    // EXTERNAL: Send to EmailJS
                    await emailjs.send("service_qiyll9e", "template_vssk4uu", {
                        to_email: r,
                        from_name: company,
                        subject: templateData.subject, // DYNAMIC SUBJECT FOR EMAILJS
                        message: finalHtml
                    });
                    document.getElementById('status').innerText = "User not in DB. Sent via EmailJS.";
                }
            } catch (err) {
                document.getElementById('status').innerText = "Error: " + err.message;
            }
        }
        window.onload = process;
    </script>
</body>
</html>
