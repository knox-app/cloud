<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Processing...</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>
<body style="font-family:sans-serif; text-align:center; padding-top:50; padding:30px; border-radius:10px; shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <h2 id="status">Verifying Request...</h2>
        <p id="debug" style="color: grey; font-size: 12px;"></p>
    </div>

    <script>
        // 1. Correct Firebase Config
        firebase.initializeApp({ 
            apiKey: "AIzaSyDPm2za3Ho0Hd8Henuhq0KxAHyUQh-Hi-U", 
            projectId: "question-metabase" 
        });
        const db = firebase.firestore();

        // 2. Correct EmailJS Public Key (Fixed typo here)
        emailjs.init("Yr9MutUoHOEONnFgn"); 

        async function process() {
            const params = new URLSearchParams(window.location.search);
            const r = params.get('r'); // Receiver Email
            const s = params.get('s'); // Secret Key
            const m = params.get('m'); // Message/Code
            const t = params.get('t'); // Template ID

            if(!r || !s || !t) {
                document.getElementById('status').innerText = "Error: Missing URL Parameters (r, s, t, or m)";
                return;
            }

            // HIDE PARAMS FROM URL
            const enc = btoa(`r=${r}&t=${t}`);
            window.history.replaceState({}, '', '5.html?id=' + enc.substring(0,8));

            try {
                // 3. Fetch Data from Firebase
                const keyDoc = await db.collection("api_keys").doc(s).get();
                const tempDoc = await db.collection("templates").doc(t).get();

                if(!keyDoc.exists) throw new Error("API Key (s) not found in Database");
                if(!tempDoc.exists) throw new Error("Template (t) not found in Database");

                const company = keyDocpx; background:#f4f4f4;">
    <div style="background:white; display:inline-block; padding:30px; border-radius:10px; shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <h2 id="status">Verifying Request...</h2>
        <p id="debug" style="color: grey; font-size: 12px;"></p>
    </div>

    <script>
        // 1. Initialize Firebase
        firebase.initializeApp({ apiKey: "AIzaSyDPm2za3Ho0Hd8Henuhq0KxAHyUQh-Hi-U", projectId: "question-metabase" });
        const db = firebase.firestore();

        // 2. Initialize EmailJS with CORRECT Public Key
        emailjs.init("Yr9MutUoHOEONnFgn"); 

        async function process() {
            const statusEl = document.getElementById('status');
            const debugEl = document.getElementById('debug');
            
            const params = new URLSearchParams(window.location.search);
            const r = params.get('r'); // Receiver
            const s = params.get('s'); // Secret Key
            const m = params.get('m'); // Code
            const t = params.get('t'); // Template ID

            if(!r || !s || !t) {
                statusEl.innerText = "Error: Missing Parameters";
                statusEl.style.color = "red";
                return;
            }

            // Encrypt and clean URL for history security
            const enc = btoa(`r=${r}&s=${s}&m=${m}`);.data().companyName;
                const templateData = tempDoc.data();
                
                // Process HTML: Replace {{code}} with parameter m
                const finalHtml = templateData.html.replace(/{{code}}/g, m || "");

                // 4. Check for Internal User
                const userDoc = await db.collection("users").doc(r).get();

                if(userDoc.exists) {
                    await db.collection("emails").add({
                        sender: company,
                        receiver: r,
                        subject: templateData.subject || "No Subject",
                        message: finalHtml,
                        status: 'inbox',
                        timestamp: Date.now()
                    });
                    document.getElementById('status').innerText = "Success: Delivered Internally";
                    document.getElementById('status').style.color = "green";
                } else {
                    // 5. EXTERNAL: Send via EmailJS
                    // We must match the variables in your EmailJS Template exactly
                    const emailParams = {
                        to_email: r,           // Your Template must use {{to_email}}
                        from_name: company,    // Your Template must use {{from_name}}
                        subject: templateData.subject || "Notification", // {{subject}}
                        message: finalHtml     // Your Template must use {{{message}}}
                    };

                    emailjs.send("service_qiyll9e", "template_vssk4uu", emailParams)
                        .then(() => {
                            document.getElementById('status').innerText = "Success: Sent via EmailJS";
                            document.getElementById('status').style.color = "green";
                        })
                        .catch((err) => {
                            console.error("EmailJS Error:", err);
                            document.getElementById('status').innerText = "EmailJS Failed (Check Console)";
                            document.getElementById('status').style.color = "red";
                            document.getElementById('debug').innerText = JSON.stringify(err);
                        });
                }
            } catch (err) {
                console.error("System Error:", err);
                document.getElementById('status').innerText = "Error: " + err.message;
                document.getElementById('status').style.color = "red";
            }
        }
        window.onload = process;
    </script>
</body>
</html>
