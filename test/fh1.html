<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Device Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root { --blue: #1a73e8; --gray: #dadce0; --green: #34a853; }
        body { font-family: 'Roboto', sans-serif; background: #f8f9fa; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid var(--gray); max-width: 450px; width: 100%; text-align: center; }
        
        .logo { font-size: 24px; font-weight: 500; margin-bottom: 20px; }
        .logo span:nth-child(1) { color: #4285F4; } .logo span:nth-child(2) { color: #EA4335; }
        .logo span:nth-child(3) { color: #FBBC05; } .logo span:nth-child(4) { color: #4285F4; }
        .logo span:nth-child(5) { color: #34A853; } .logo span:nth-child(6) { color: #EA4335; }

        .key-display { background: #e8f0fe; color: var(--blue); padding: 15px; border-radius: 8px; font-family: monospace; font-size: 14px; margin: 15px 0; border: 1px dashed var(--blue); word-break: break-all; }
        
        .status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background-color: var(--green); box-shadow: 0 0 8px var(--green); }

        input { width: 100%; padding: 12px; border: 1px solid var(--gray); border-radius: 6px; margin-top: 20px; box-sizing: border-box; font-size: 14px; outline: none; }
        input:focus { border-color: var(--blue); }

        button { width: 100%; background: var(--blue); color: white; border: none; padding: 12px; border-radius: 6px; margin-top: 10px; cursor: pointer; font-weight: 500; }
        
        #map-link { display: none; margin-top: 20px; padding: 15px; background: #f1f3f4; border-radius: 8px; text-decoration: none; color: var(--blue); font-weight: 500; }
        #map-link:hover { background: #e8eaed; }
    </style>
</head>
<body>

<div class="card">
    <div class="logo"><span>G</span><span>o</span><span>o</span><span>g</span><span>l</span><span>e</span></div>
    
    <!-- YOUR KEY SECTION -->
    <h2 style="font-size: 18px; margin: 0;">Your Device Key</h2>
    <div class="key-display" id="my-key">Generating...</div>
    <div style="font-size: 12px; color: #5f6368;">
        <span id="status-dot" class="status-dot"></span>
        <span id="status-text">GPS: Off</span>
    </div>

    <hr style="margin: 25px 0; border: 0; border-top: 1px solid var(--gray);">

    <!-- TRACKER SECTION -->
    <h2 style="font-size: 18px; margin: 0;">Track Someone Else</h2>
    <input type="text" id="target-key" placeholder="Paste 25-digit key here">
    <button onclick="startTracking()">Track Live Location</button>

    <a id="map-link" target="_blank">
        üìç View Live on Google Maps
        <div id="last-seen" style="font-size: 10px; color: #5f6368; font-weight: normal; margin-top: 5px;"></div>
    </a>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDL7sPp-FkG59L-mRQ7BrCGgeKMhQC80iw",
        authDomain: "xperts-metadata.firebaseapp.com",
        projectId: "xperts-metadata",
        storageBucket: "xperts-metadata.firebasestorage.app",
        messagingSenderId: "514845910910",
        appId: "1:514845910910:web:5a2402130a97b5d749b52f",
        measurementId: "G-CQ5KWGJSZB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 1. PERSISTENT KEY GENERATION
    let myKey = localStorage.getItem('device_tracker_id');
    if (!myKey) {
        const charset = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        myKey = Array.from({length: 25}, () => charset[Math.floor(Math.random() * charset.length)]).join('');
        localStorage.setItem('device_tracker_id', myKey);
    }
    document.getElementById('my-key').innerText = myKey;

    // 2. SEND LIVE LOCATION (SENDER)
    if ("geolocation" in navigator) {
        navigator.geolocation.watchPosition(async (position) => {
            const { latitude, longitude } = position.coords;
            
            // Update UI
            document.getElementById('status-dot').className = "status-dot online";
            document.getElementById('status-text').innerText = "GPS: Streaming Live";

            // Save to Firebase
            try {
                await setDoc(doc(db, "live_trackers", myKey), {
                    lat: latitude,
                    lng: longitude,
                    updatedAt: serverTimestamp()
                }, { merge: true });
            } catch (e) { console.error(e); }

        }, (err) => {
            document.getElementById('status-text').innerText = "GPS: Permission Denied";
        }, { enableHighAccuracy: true });
    }

    // 3. TRACK ANOTHER DEVICE (RECEIVER)
    window.startTracking = () => {
        const targetId = document.getElementById('target-key').value.trim();
        if (targetId.length < 20) {
            alert("Please enter a valid 25-digit key");
            return;
        }

        const mapLink = document.getElementById('map-link');
        
        // Listen to live updates from Firebase
        onSnapshot(doc(db, "live_trackers", targetId), (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data.lat && data.lng) {
                    const url = `https://www.google.com/maps?q=${data.lat},${data.lng}`;
                    mapLink.href = url;
                    mapLink.style.display = "block";
                    document.getElementById('last-seen').innerText = "Last updated: " + new Date().toLocaleTimeString();
                }
            } else {
                alert("Device not found or not sharing location.");
            }
        });
    };
</script>

</body>
</html>
