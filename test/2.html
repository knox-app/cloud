<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Inbox - MailSystem</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; }
        .sidebar { width: 200px; background: #202124; color: white; padding: 20px; }
        .sidebar a { display: block; color: white; text-decoration: none; padding: 10px 0; border-bottom: 1px solid #333; }
        .main { flex: 1; overflow-y: auto; padding: 20px; background: #f8f9fa; }
        .email-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 5px; cursor: pointer; border-left: 5px solid #007bff; display: flex; justify-content: space-between; }
        .full-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: none; flex-direction: column; }
        .full-view-header { padding: 20px; background: #eee; display: flex; justify-content: space-between; }
        iframe { flex: 1; border: none; width: 100%; }
        .btn-group button { margin-left: 5px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h3 id="userName">User</h3>
        <a href="2.html">Inbox</a>
        <a href="2.html?v=archive">Archive</a>
        <a href="2.html?v=trash">Trash</a>
        <a href="3.html">Compose</a>
        <a href="4.html">Console</a>
    </div>
    <div class="main" id="emailList">
        Loading emails...
    </div>

    <div id="fullView" class="full-view">
        <div class="full-view-header">
            <button onclick="closeFullView()">Back</button>
            <div id="actionButtons"></div>
        </div>
        <iframe id="mailContent"></iframe>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDPm2za3Ho0Hd8Henuhq0KxAHyUQh-Hi-U",
            projectId: "question-metabase",
            appId: "1:770698198753:web:59ae49d78b6013bab5c1a0"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const currentUser = JSON.parse(localStorage.getItem("user"));
        if(!currentUser) window.location.href = "1.html";

        document.getElementById('userName').innerText = currentUser.firstName;
        const urlParams = new URLSearchParams(window.location.search);
        const view = urlParams.get('v') || 'inbox';

        // Real-time listener
        db.collection("emails")
          .where("receiver", "==", currentUser.email)
          .where("status", "==", view)
          .onSnapshot((snapshot) => {
            const list = document.getElementById("emailList");
            list.innerHTML = `<h2>${view.toUpperCase()}</h2>`;
            
            snapshot.forEach((doc) => {
                const mail = doc.data();
                const id = doc.id;
                
                // Trash Auto-Delete Logic (7 Days = 604800000 ms)
                if(view === 'trash' && (Date.now() - mail.timestamp > 604800000)) {
                    db.collection("emails").doc(id).delete();
                    return;
                }

                const div = document.createElement('div');
                div.className = 'email-item';
                div.innerHTML = `<span><b>${mail.sender}</b>: ${mail.subject || '(No Subject)'}</span> <span>${new Date(mail.timestamp).toLocaleDateString()}</span>`;
                div.onclick = () => openMail(id, mail);
                list.appendChild(div);
            });
        });

        function openMail(id, mail) {
            const fv = document.getElementById('fullView');
            const frame = document.getElementById('mailContent');
            fv.style.display = 'flex';
            // Fix HTML content: using srcdoc to render HTML strings safely
            frame.srcdoc = `<h3>From: ${mail.sender}</h3><hr>${mail.message}`;
            
            document.getElementById('actionButtons').innerHTML = `
                <button onclick="updateStatus('${id}', 'archive')">Archive</button>
                <button onclick="updateStatus('${id}', 'trash')">Trash</button>
            `;
        }

        async function updateStatus(id, newStatus) {
            await db.collection("emails").doc(id).update({ status: newStatus });
            closeFullView();
        }

        function closeFullView() { document.getElementById('fullView').style.display = 'none'; }
    </script>
</body>
</html>
