<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cloud Console - Security & Logs</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        :root { --primary: #4f46e5; --dark: #0f172a; --bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); display: flex; height: 100vh; }
        .sidebar { width: 260px; background: var(--dark); color: #94a3b8; display: flex; flex-direction: column; }
        .sidebar h2 { color: white; padding: 20px; border-bottom: 1px solid #1e293b; margin: 0; }
        .nav-item { padding: 15px 20px; cursor: pointer; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: #1e293b; color: white; border-left: 4px solid var(--primary); }
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 25px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        code { background: #f1f5f9; padding: 4px 8px; border-radius: 4px; color: #e11d48; font-size: 12px; }
        .btn { background: var(--primary); color: white; border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; }
        .hidden { display: none; }
        textarea { width: 100%; height: 100px; font-family: monospace; font-size: 12px; background: #272822; color: #fff; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>BigTech Cloud</h2>
        <div class="nav-item active" onclick="tab('projects')">Projects & Keys</div>
        <div class="nav-item" onclick="tab('templates')">Design Templates</div>
        <div class="nav-item" onclick="tab('logs')">Security Logs</div>
        <div class="nav-item" onclick="tab('users')">Manage Users</div>
    </div>

    <div class="main">
        <div id="projects" class="tab">
            <div class="card">
                <h3>Create New App Project</h3>
                <input type="text" id="p_name" placeholder="Project Name (Netflix, Amazon etc)" style="width:70%; padding:10px;">
                <button class="btn" onclick="createProject()">Create Project</button>
            </div>
            <div class="card">
                <h3>API Keys & Embed Snippets</h3>
                <table id="projectTable">
                    <thead><tr><th>Project</th><th>API Key</th><th>Embed Code</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="templates" class="tab hidden">
            <div class="card">
                <h3>Template Builder</h3>
                <select id="t_proj" style="width:100%; padding:10px; margin-bottom:10px;"></select>
                <input type="text" id="t_sub" placeholder="Email Subject" style="width:100%; padding:10px; margin-bottom:10px;">
                <textarea id="t_html" placeholder="HTML Body (Use {{code}} for OTPs)"></textarea>
                <button class="btn" style="margin-top:10px" onclick="saveTemplate()">Save Template</button>
            </div>
            <div class="card" id="tempList"></div>
        </div>

        <div id="logs" class="tab hidden">
            <div class="card">
                <h3>Delivery & Security Logs</h3>
                <table id="logTable">
                    <thead><tr><th>Time</th><th>Receiver</th><th>Method</th><th>Project</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="users" class="tab hidden">
            <div class="card">
                <h3>User Directory</h3>
                <table id="userTable">
                    <thead><tr><th>Name</th><th>Email</th><th>Mobile</th><th>Action</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        firebase.initializeApp({ apiKey: "AIzaSyDPm2za3Ho0Hd8Henuhq0KxAHyUQh-Hi-U", projectId: "question-metabase" });
        const db = firebase.firestore();
        const user = JSON.parse(localStorage.getItem("user"));

        function tab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.add('hidden'));
            document.getElementById(name).classList.remove('hidden');
            loadData(name);
        }

        async function createProject() {
            const key = "SK-" + Math.random().toString(36).substr(2, 10).toUpperCase();
            await db.collection("api_keys").doc(key).set({
                companyName: document.getElementById('p_name').value,
                key: key, owner: user.email, timestamp: Date.now()
            });
            loadData('projects');
        }

        async function loadData(name) {
            if(name === 'projects') {
                const snap = await db.collection("api_keys").where("owner", "==", user.email).get();
                const tbody = document.querySelector("#projectTable tbody");
                tbody.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    tbody.innerHTML += `<tr>
                        <td>${d.companyName}</td>
                        <td><code>${d.key}</code></td>
                        <td><button class="btn" style="font-size:10px" onclick="showEmbed('${d.key}')">Get Code</button></td>
                    </tr>`;
                });
            }
            if(name === 'logs') {
                const snap = await db.collection("logs").orderBy("timestamp", "desc").limit(20).get();
                const tbody = document.querySelector("#logTable tbody");
                tbody.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    tbody.innerHTML += `<tr><td>${new Date(d.timestamp).toLocaleTimeString()}</td><td>${d.receiver}</td><td>${d.method}</td><td>${d.projectName}</td></tr>`;
                });
            }
            if(name === 'templates') {
                const projSelect = document.getElementById('t_proj');
                const pSnap = await db.collection("api_keys").where("owner", "==", user.email).get();
                projSelect.innerHTML = "";
                pSnap.forEach(p => projSelect.innerHTML += `<option value="${p.id}">${p.data().companyName}</option>`);
            }
        }

        function showEmbed(key) {
            const code = `<script>
function sendMail(email, templateID, code) {
  const url = "5.html?r=" + email + "&s=${key}&t=" + templateID + "&m=" + code;
  fetch(url, { mode: 'no-cors' }).then(() => console.log('Triggered'));
}
<\/script>`;
            prompt("Copy this code to your website background button click:", code);
        }

        async function saveTemplate() {
            const tid = "T-" + Math.random().toString(36).substr(2, 5).toUpperCase();
            await db.collection("templates").doc(tid).set({
                id: tid, subject: document.getElementById('t_sub').value,
                html: document.getElementById('t_html').value,
                apiKey: document.getElementById('t_proj').value,
                ownerEmail: user.email
            });
            alert("Template ID: " + tid);
        }

        loadData('projects');
    </script>
</body>
</html>
