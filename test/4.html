<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Developer Console - API Access</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        :root { --primary: #2563eb; --dark: #0f172a; --bg: #f1f5f9; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: #334155; }
        
        /* Setup Screen Style */
        #setup-screen { display: none; justify-content: center; align-items: center; height: 100vh; }
        .setup-card { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 400px; text-align: center; }
        
        /* Dashboard Screen Style */
        #admin-screen { display: none; height: 100vh; flex-direction: row; }
        .sidebar { width: 260px; background: var(--dark); color: white; display: flex; flex-direction: column; }
        .sidebar h2 { padding: 20px; font-size: 1.2rem; border-bottom: 1px solid #1e293b; margin:0; }
        .nav-btn { padding: 15px 20px; cursor: pointer; border: none; background: none; color: #94a3b8; text-align: left; width: 100%; font-size: 14px; }
        .nav-btn.active { background: var(--primary); color: white; }
        
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; }
        button.action { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 600; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #f1f5f9; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <!-- SCREEN 1: Setup for New API Users -->
    <div id="setup-screen">
        <div class="setup-card">
            <img src="https://cdn-icons-png.flaticon.com/512/2103/2103633.png" width="80" style="margin-bottom:20px">
            <h2>Activate API Access</h2>
            <p style="color:#64748b; font-size:14px">Create your developer key to start sending automated emails.</p>
            <input type="text" id="api_company" placeholder="Company / App Name">
            <input type="text" id="api_type" placeholder="Content Type (e.g. Fintech, Social)">
            <input type="text" id="api_pic" placeholder="Profile Picture URL">
            <button class="action" onclick="createNewApiKey()">Generate My API Key</button>
        </div>
    </div>

    <!-- SCREEN 2: Dashboard for Existing API Users -->
    <div id="admin-screen">
        <div class="sidebar">
            <h2>Console</h2>
            <button class="nav-btn active" onclick="switchTab('dash')">Dashboard</button>
            <button class="nav-btn" onclick="switchTab('temps')">Templates</button>
            <button class="nav-btn" onclick="switchTab('users')">Manage Users</button>
            <button class="nav-btn" onclick="location.href='2.html'">Mailbox</button>
            <button class="nav-btn" style="margin-top:auto; background:#be123c; color:white;" onclick="localStorage.clear(); location.href='1.html'">Logout</button>
        </div>
        
        <div class="main">
            <!-- Tab: Dashboard -->
            <div id="tab-dash" class="tab-content">
                <div class="card">
                    <h3>Your Developer Profile</h3>
                    <p><strong>Company:</strong> <span id="view-comp"></span></p>
                    <p><strong>Your Key:</strong> <code id="view-key" style="background:#eee; padding:5px; color:red"></code></p>
                    <p style="font-size:12px; color:grey">Share this key only with your system backend.</p>
                </div>
            </div>

            <!-- Tab: Templates -->
            <div id="tab-temps" class="tab-content hidden">
                <div class="card">
                    <h3>New Template</h3>
                    <input type="text" id="t_name" placeholder="Name">
                    <input type="text" id="t_sub" placeholder="Email Subject">
                    <textarea id="t_html" placeholder="HTML Body (use {{code}})"></textarea>
                    <button class="action" onclick="saveTemplate()">Save Template</button>
                </div>
                <div class="card" id="template-list"></div>
            </div>

            <!-- Tab: Manage Users -->
            <div id="tab-users" class="tab-content hidden">
                <div class="card">
                    <h3>Registered System Users</h3>
                    <table>
                        <thead><tr><th>Name</th><th>Email</th><th>Action</th></tr></thead>
                        <tbody id="user-rows"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        firebase.initializeApp({ apiKey: "AIzaSyDPm2za3Ho0Hd8Henuhq0KxAHyUQh-Hi-U", projectId: "question-metabase" });
        const db = firebase.firestore();
        const currentUser = JSON.parse(localStorage.getItem("user"));
        if(!currentUser) window.location.href = "1.html";

        let userApiKey = null;

        async function checkApiStatus() {
            // Check if user already has an API key
            const snap = await db.collection("api_keys").where("owner", "==", currentUser.email).get();
            
            if(snap.empty) {
                document.getElementById('setup-screen').style.display = 'flex';
                document.getElementById('admin-screen').style.display = 'none';
            } else {
                userApiKey = snap.docs[0].id;
                const data = snap.docs[0].data();
                document.getElementById('setup-screen').style.display = 'none';
                document.getElementById('admin-screen').style.display = 'flex';
                document.getElementById('view-comp').innerText = data.companyName;
                document.getElementById('view-key').innerText = userApiKey;
                loadDashboardData();
            }
        }

        async function createNewApiKey() {
            const name = document.getElementById('api_company').value;
            const type = document.getElementById('api_type').value;
            const pic = document.getElementById('api_pic').value;

            if(!name || !type) return alert("Fill Name and Type");

            // Generate a random Secret Key
            const newKey = "SK-" + Math.random().toString(36).substr(2, 10).toUpperCase();

            await db.collection("api_keys").doc(newKey).set({
                companyName: name,
                type: type,
                profilePic: pic,
                owner: currentUser.email,
                id: newKey
            });

            alert("API Key Generated Successfully!");
            checkApiStatus(); // Refresh to show dashboard
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.getElementById('tab-'+tab).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        async function loadDashboardData() {
            // Load Templates
            const tSnap = await db.collection("templates").where("ownerEmail", "==", currentUser.email).get();
            const tDiv = document.getElementById('template-list');
            tDiv.innerHTML = "<h3>My Templates</h3>";
            tSnap.forEach(doc => {
                const d = doc.data();
                tDiv.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee;">
                    <b>${d.name}</b> <br> <small>ID: ${d.id}</small>
                </div>`;
            });

            // Load Users
            const uSnap = await db.collection("users").get();
            const uBody = document.getElementById('user-rows');
            uBody.innerHTML = "";
            uSnap.forEach(doc => {
                const u = doc.data();
                uBody.innerHTML += `<tr>
                    <td>${u.firstName} ${u.lastName}</td>
                    <td>${u.email}</td>
                    <td><button onclick="editUser('${u.email}')">Edit</button></td>
                </tr>`;
            });
        }

        async function saveTemplate() {
            const id = "TID-" + Math.random().toString(36).substr(2, 5).toUpperCase();
            await db.collection("templates").doc(id).set({
                id: id,
                name: document.getElementById('t_name').value,
                subject: document.getElementById('t_sub').value,
                html: document.getElementById('t_html').value,
                ownerEmail: currentUser.email,
                apiKey: userApiKey
            });
            alert("Template Saved!");
            loadDashboardData();
        }

        function editUser(email) {
            const newName = prompt("Enter New First Name:");
            if(newName) {
                db.collection("users").doc(email).update({ firstName: newName })
                .then(() => loadDashboardData());
            }
        }

        checkApiStatus();
    </script>
</body>
    </html>
