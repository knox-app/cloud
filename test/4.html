<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Console -  Builder</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f4f7f6; display: flex; height: 100vh; }
        .sidebar { width: 260px; background: #2c3e50; color: white; padding: 20px; box-sizing: border-box; }
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        textarea { height: 150px; font-family: 'Courier New', monospace; background: #1e1e1e; color: #d4d4d4; }
        button { background: #3498db; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 10px; }
        button:hover { background: #2980b9; }
        .template-item { background: #fff; border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
        .badge { background: #e8f4fd; color: #3498db; padding: 4px 10px; border-radius: 20px; font-size: 11px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>Console</h2>
        <p id="compDisplay">Loading...</p>
        <button onclick="location.href='2.html'" style="background:#445566; margin-top:20px;">Exit Console</button>
    </div>

    <div class="main">
        <div class="card">
            <h3>Create Template</h3>
            <input type="text" id="t_name" placeholder="Internal Template Name (e.g. OTP V1)">
            
            <!-- NEW SUBJECT FIELD -->
            <input type="text" id="t_subject" placeholder="Email Subject Line (What the customer sees)">
            
            <select id="t_type">
                <option value="security">Security / OTP</option>
                <option value="marketing">Marketing</option>
                <option value="system">System Alert</option>
            </select>
            <textarea id="t_html" placeholder="HTML Body Content... Use {{code}} for dynamic values."></textarea>
            <button onclick="saveTemplate()">Create Template</button>
        </div>

        <div class="card">
            <h3>Your Saved Templates</h3>
            <div id="templateList"></div>
        </div>
    </div>

    <script>
        firebase.initializeApp({ apiKey: "AIzaSyDPm2za3Ho0Hd8Henuhq0KxAHyUQh-Hi-U", projectId: "question-metabase" });
        const db = firebase.firestore();
        const user = JSON.parse(localStorage.getItem("user"));

        async function init() {
            const keySnap = await db.collection("api_keys").where("owner", "==", user.email).get();
            if(!keySnap.empty) {
                window.myKey = keySnap.docs[0].id;
                document.getElementById('compDisplay').innerText = keySnap.docs[0].data().companyName;
            }
            loadTemplates();
        }

        async function saveTemplate() {
            const tid = "T-" + Math.random().toString(36).substr(2, 5).toUpperCase();
            await db.collection("templates").doc(tid).set({
                id: tid,
                name: document.getElementById('t_name').value,
                subject: document.getElementById('t_subject').value, // SAVING SUBJECT
                type: document.getElementById('t_type').value,
                html: document.getElementById('t_html').value,
                ownerEmail: user.email,
                apiKey: window.myKey
            });
            alert("Template Created!");
            loadTemplates();
        }

        async function loadTemplates() {
            const snap = await db.collection("templates").where("ownerEmail", "==", user.email).get();
            const list = document.getElementById('templateList');
            list.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                list.innerHTML += `
                <div class="template-item">
                    <div>
                        <strong>${d.name}</strong> <span class="badge">${d.type}</span><br>
                        <small>Subject: ${d.subject}</small>
                    </div>
                    <button style="width:auto; padding:5px 10px;" onclick="copyLink('${d.id}')">Get URL</button>
                </div>`;
            });
        }

        function copyLink(tid) {
            const url = `${window.location.origin}/5.html?r=EMAIL&s=${window.myKey}&t=${tid}&m=123456`;
            prompt("Copy this URL:", url);
        }

        init();
    </script>
</body>
</html>
