<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cloud Console - Security & Projects</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        :root { --primary: #6366f1; --dark: #0f172a; --bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); display: flex; height: 100vh; }
        .sidebar { width: 260px; background: var(--dark); color: #94a3b8; display: flex; flex-direction: column; }
        .sidebar h2 { color: white; padding: 20px; border-bottom: 1px solid #1e293b; margin: 0; }
        .nav-item { padding: 15px 20px; cursor: pointer; border-left: 4px solid transparent; }
        .nav-item.active { background: #1e293b; color: white; border-left-color: var(--primary); }
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 25px; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #e2e8f0; border-radius: 8px; }
        .btn { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        code { background: #f1f5f9; padding: 3px 6px; border-radius: 4px; color: #ef4444; font-size: 12px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>BigTech Cloud</h2>
        <div class="nav-item active" onclick="tab('projects')">API Projects</div>
        <div class="nav-item" onclick="tab('templates')">Templates</div>
        <div class="nav-item" onclick="tab('logs')">System Logs</div>
        <div class="nav-item" onclick="location.href='2.html'">Mailbox</div>
    </div>

    <div class="main">
        <!-- Projects View -->
        <div id="projects" class="tab">
            <div class="card">
                <h3>New Project Integration</h3>
                <p style="font-size:13px; color:grey;">Authorized Domain: The URL where your "Send" button exists (e.g. yoursite.com)</p>
                <input type="text" id="p_name" placeholder="Project Name (e.g. Netflix OTP)">
                <input type="text" id="p_domain" placeholder="Authorized Domain (e.g. knox-app.github.io)">
                <button class="btn" onclick="createProject()">Create Project & Key</button>
            </div>
            <div class="card">
                <h3>Active API Project Keys</h3>
                <table id="projectTable">
                    <thead><tr><th>Project</th><th>Allowed Domain</th><th>Secret Key</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Templates View -->
        <div id="templates" class="tab hidden">
            <div class="card">
                <h3>Template Designer</h3>
                <select id="t_proj"></select>
                <input type="text" id="t_sub" placeholder="Email Subject Line">
                <textarea id="t_html" style="width:100%; height:100px; padding:10px;" placeholder="HTML Body Content... use {{code}}"></textarea>
                <button class="btn" style="margin-top:10px" onclick="saveTemplate()">Save Template</button>
            </div>
            <div class="card" id="tempList"></div>
        </div>

        <!-- Logs View -->
        <div id="logs" class="tab hidden">
            <div class="card">
                <h3>Recent Sent Logs</h3>
                <table id="logTable">
                    <thead><tr><th>Time</th><th>Receiver</th><th>Method</th><th>Domain Status</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        firebase.initializeApp({ apiKey: "AIzaSyDPm2za3Ho0Hd8Henuhq0KxAHyUQh-Hi-U", projectId: "question-metabase" });
        const db = firebase.firestore();
        const user = JSON.parse(localStorage.getItem("user"));

        function tab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.add('hidden'));
            document.getElementById(name).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.target.classList.add('active');
            loadData(name);
        }

        async function createProject() {
            const key = "SK-" + Math.random().toString(36).substr(2, 12).toUpperCase();
            await db.collection("api_keys").doc(key).set({
                companyName: document.getElementById('p_name').value,
                allowedDomain: document.getElementById('p_domain').value,
                key: key, owner: user.email, timestamp: Date.now()
            });
            loadData('projects');
        }

        async function loadData(name) {
            if(name === 'projects') {
                const snap = await db.collection("api_keys").where("owner", "==", user.email).get();
                const tbody = document.querySelector("#projectTable tbody");
                tbody.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    tbody.innerHTML += `<tr><td>${d.companyName}</td><td><code>${d.allowedDomain}</code></td><td><code>${d.key}</code></td></tr>`;
                });
            }
            if(name === 'logs') {
                const snap = await db.collection("logs").orderBy("timestamp", "desc").limit(15).get();
                const tbody = document.querySelector("#logTable tbody");
                tbody.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    tbody.innerHTML += `<tr><td>${new Date(d.timestamp).toLocaleTimeString()}</td><td>${d.receiver}</td><td>${d.method}</td><td>Verified</td></tr>`;
                });
            }
            if(name === 'templates') {
                const projSelect = document.getElementById('t_proj');
                const pSnap = await db.collection("api_keys").where("owner", "==", user.email).get();
                projSelect.innerHTML = "";
                pSnap.forEach(p => projSelect.innerHTML += `<option value="${p.id}">${p.data().companyName}</option>`);
            }
        }

        async function saveTemplate() {
            const tid = "T-" + Math.random().toString(36).substr(2, 5).toUpperCase();
            await db.collection("templates").doc(tid).set({
                id: tid, subject: document.getElementById('t_sub').value,
                html: document.getElementById('t_html').value,
                apiKey: document.getElementById('t_proj').value,
                ownerEmail: user.email
            });
            alert("Saved! Template ID: " + tid);
        }

        loadData('projects');
    </script>
</body>
</html>
