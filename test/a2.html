<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Login</title>
    <style>
        /* --- PROFESSIONAL SAAS THEME --- */
        :root {
            --primary: #000000;
            --primary-hover: #333333;
            --bg: #F5F5F5;
            --card-bg: #FFFFFF;
            --border: #E5E5E5;
            --text-main: #171717;
            --text-sub: #737373;
            --input-bg: #FFFFFF;
            --focus-ring: rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* --- CARD DESIGN --- */
        .auth-card {
            background: var(--card-bg);
            width: 100%;
            max-width: 420px;
            padding: 48px;
            border-radius: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid var(--border);
            position: relative;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        /* --- ANIMATIONS --- */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

        .hidden { display: none !important; }

        /* --- TYPOGRAPHY --- */
        .logo {
            width: 48px;
            height: 48px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 24px;
            margin: 0 auto 24px auto;
        }

        h1 { font-size: 24px; font-weight: 700; text-align: center; margin-bottom: 8px; letter-spacing: -0.5px; }
        p.subtitle { text-align: center; color: var(--text-sub); font-size: 14px; margin-bottom: 32px; }

        /* --- FORMS --- */
        .input-group { margin-bottom: 16px; position: relative; }
        
        label { display: block; font-size: 12px; font-weight: 600; color: var(--text-sub); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        input {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            outline: none;
            background: var(--input-bg);
            transition: all 0.2s;
            color: var(--text-main);
        }

        input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--focus-ring); }

        button {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 8px;
        }

        button:hover { background: var(--primary-hover); }
        button:disabled { opacity: 0.7; cursor: not-allowed; }

        .back-btn {
            background: transparent;
            color: var(--text-sub);
            font-size: 13px;
            margin-top: 20px;
            padding: 8px;
        }
        .back-btn:hover { background: transparent; color: var(--text-main); text-decoration: underline; }

        /* --- OTP INPUT --- */
        .otp-display {
            text-align: center;
            font-size: 32px;
            letter-spacing: 10px;
            font-family: monospace;
            font-weight: bold;
            text-transform: uppercase;
        }

        /* --- FOOTER --- */
        .secured-by {
            text-align: center;
            margin-top: 30px;
            font-size: 11px;
            color: #ccc;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        /* --- MOBILE --- */
        @media (max-width: 480px) {
            .auth-card {
                height: 100vh;
                border-radius: 0;
                border: none;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
        }

        /* --- REGISTER LINK (For Demo) --- */
        .demo-link {
            text-align: center;
            margin-top: 15px;
            font-size: 13px;
            color: var(--text-sub);
        }
        .demo-link span { color: var(--primary); font-weight: 600; cursor: pointer; }
    </style>
</head>
<body>

    <div class="auth-card fade-in">
        <!-- HEADER -->
        <div class="logo">K</div>
        <h1 id="appTitle">Loading...</h1>
        <p class="subtitle" id="appDomain">Please identify yourself</p>

        <!-- STEP 1: EMAIL -->
        <div id="step-email">
            <form onsubmit="goToStep2(event)">
                <div class="input-group">
                    <label>Email Address</label>
                    <input id="email" type="email" placeholder="name@company.com" required autofocus>
                </div>
                <button type="submit">Continue</button>
            </form>
            
            <!-- Helper for new users -->
            <div class="demo-link">
                New here? <span onclick="toggleRegister()">Create Account</span>
            </div>
        </div>

        <!-- STEP 2: PASSWORD -->
        <div id="step-password" class="hidden">
            <div class="input-group">
                <label>Password</label>
                <input id="password" type="password" placeholder="••••••••••" required>
            </div>
            <button onclick="handleLogin()">Sign In</button>
            <button class="back-btn" onclick="goBack()">← Change Email</button>
        </div>

        <!-- STEP 3: OTP (MAGIC LINK) -->
        <div id="step-otp" class="hidden">
            <div style="background: #f0fdf4; padding: 12px; border-radius: 8px; color: #166534; font-size: 13px; margin-bottom: 20px; text-align: center;">
                We sent a 6-digit code to your email.
            </div>
            <div class="input-group">
                <input id="otp" class="otp-display" maxlength="6" placeholder="000000">
            </div>
            <button onclick="handleLogin()">Verify Code</button>
            <p style="text-align: center; font-size: 11px; color: #999; margin-top: 10px;">(Use code <b>123456</b> for testing)</p>
            <button class="back-btn" onclick="goBack()">← Change Email</button>
        </div>

        <!-- FOOTER -->
        <div class="secured-by">
            Secured by Knox Cloud
        </div>

        <!-- REGISTER OVERLAY (Simple Prompt) -->
        <div id="reg-overlay" class="hidden" style="position:absolute; inset:0; background:white; padding:40px; z-index:10; border-radius:24px;">
            <h2 style="text-align:center; margin-bottom:20px;">Create User</h2>
            <input id="newEmail" placeholder="Email" style="margin-bottom:10px;">
            <input id="newPass" placeholder="Password" style="margin-bottom:20px;">
            <button onclick="createUser()">Save User</button>
            <button class="back-btn" onclick="toggleRegister()">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- FIREBASE CONFIG (Same as yours) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDPm2za3Ho0Hd8Henuhq0KxAHyUQh-Hi-U",
            authDomain: "question-metabase.firebaseapp.com",
            projectId: "question-metabase",
            storageBucket: "question-metabase.firebasestorage.app",
            messagingSenderId: "770698198753",
            appId: "1:770698198753:web:59ae49d78b6013bab5c1a0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- LOGIC ---
        const params = new URLSearchParams(window.location.search);
        const apiKey = params.get('key');
        let appData = null;

        // 1. Load App Config
        async function init() {
            if(!apiKey) {
                document.body.innerHTML = "<h3 style='color:red'>Error: Missing API Key</h3>";
                return;
            }

            const q = query(collection(db, "apps"), where("apiKey", "==", apiKey));
            const snap = await getDocs(q);

            if(snap.empty) {
                document.body.innerHTML = "<h3 style='color:red'>Error: Invalid API Key</h3>";
                return;
            }

            appData = snap.docs[0].data();
            document.getElementById('appTitle').innerText = appData.name;
            document.getElementById('appDomain').innerText = "Sign in to " + appData.domain;
            document.title = "Login | " + appData.name;
        }
        init();

        // 2. Navigation Flow
        window.goToStep2 = (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            if(!email) return;

            document.getElementById('step-email').classList.add('hidden');
            
            // Check App Config: Password vs OTP
            if(appData.method === "Email+Pass") {
                document.getElementById('step-password').classList.remove('hidden');
                document.getElementById('password').focus();
            } else {
                document.getElementById('step-otp').classList.remove('hidden');
                document.getElementById('otp').focus();
            }
        };

        window.goBack = () => {
            document.getElementById('step-email').classList.remove('hidden');
            document.getElementById('step-password').classList.add('hidden');
            document.getElementById('step-otp').classList.add('hidden');
        };

        // 3. Login Verification
        window.handleLogin = async () => {
            const email = document.getElementById('email').value;
            let success = false;
            let btn = document.querySelector('button:not(.back-btn)'); // Select active button
            btn.innerText = "Verifying...";

            if(appData.method === "Email+Pass") {
                const pass = document.getElementById('password').value;
                // Verify against Firestore 'users' collection
                const q = query(collection(db, "users"), where("email", "==", email), where("password", "==", pass));
                const snap = await getDocs(q);
                if(!snap.empty) success = true;
                else alert("Invalid email or password");
            } else {
                // Verify OTP (Mock: 123456)
                const otp = document.getElementById('otp').value;
                if(otp === "123456") success = true;
                else alert("Invalid Code");
            }

            if(success) {
                // Generate Token
                const token = "T-" + Math.random().toString(36).toUpperCase().substr(2, 8);
                
                // Determine separator (? or &)
                const hasQuery = appData.redirect.includes('?');
                const sep = hasQuery ? '&' : '?';
                
                // Final URL
                const finalUrl = `${appData.redirect}${sep}r=${email}&s=${apiKey}&t=${token}&m=success`;
                
                btn.innerText = "Success! Redirecting...";
                setTimeout(() => window.location.href = finalUrl, 800);
            } else {
                btn.innerText = "Sign In";
            }
        };

        // --- DEMO HELPERS ---
        window.toggleRegister = () => {
            const el = document.getElementById('reg-overlay');
            el.classList.toggle('hidden');
        };

        window.createUser = async () => {
            const e = document.getElementById('newEmail').value;
            const p = document.getElementById('newPass').value;
            if(e && p) {
                await addDoc(collection(db, "users"), { email: e, password: p });
                alert("User created! You can now log in.");
                toggleRegister();
            }
        };
    </script>
</body>
    </html>
