<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Login</title>
    <style>
        :root { --primary: #000; --bg: #F5F5F5; --card-bg: #FFF; --border: #E5E5E5; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, sans-serif; }
        
        body { background-color: var(--bg); color: #171717; height: 100vh; display: flex; align-items: center; justify-content: center; }

        .auth-card {
            background: var(--card-bg); width: 100%; max-width: 420px; padding: 48px;
            border-radius: 24px; border: 1px solid var(--border); box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            animation: fadeIn 0.4s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .hidden { display: none !important; }

        .logo { width: 48px; height: 48px; background: var(--primary); color: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; margin: 0 auto 24px; }
        h1 { font-size: 24px; text-align: center; margin-bottom: 8px; }
        p.subtitle { text-align: center; color: #737373; font-size: 14px; margin-bottom: 32px; }

        label { display: block; font-size: 12px; font-weight: 600; color: #737373; margin-bottom: 6px; text-transform: uppercase; }
        input { width: 100%; padding: 14px; font-size: 16px; border: 1px solid var(--border); border-radius: 12px; outline: none; margin-bottom: 16px; }
        input:focus { border-color: var(--primary); }

        button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; }
        button:hover { opacity: 0.9; }
        .back-btn { background: transparent; color: #737373; font-size: 13px; margin-top: 20px; }
        
        .otp-display { text-align: center; font-size: 32px; letter-spacing: 10px; font-weight: bold; font-family: monospace; text-transform: uppercase; }
        
        .secured-by { text-align: center; margin-top: 30px; font-size: 11px; color: #ccc; text-transform: uppercase; font-weight: 600; }
        
        /* Mobile */
        @media (max-width: 480px) { .auth-card { height: 100vh; border-radius: 0; border: none; display: flex; flex-direction: column; justify-content: center; } }
        
        /* Demo Overlay */
        #reg-overlay { position:absolute; inset:0; background:white; padding:40px; z-index:10; border-radius:24px; display:flex; flex-direction:column; justify-content:center; }
    </style>
</head>
<body>

    <div class="auth-card">
        <div class="logo">K</div>
        <h1 id="appTitle">Loading...</h1>
        <p class="subtitle" id="appDomain">Please identify yourself</p>

        <!-- STEP 1: EMAIL -->
        <div id="step-email">
            <form onsubmit="goToStep2(event)">
                <label>Email Address</label>
                <input id="email" type="email" placeholder="name@company.com" required autofocus>
                <button type="submit">Continue</button>
            </form>
            <div style="text-align:center; margin-top:15px; font-size:13px; color:#777;">
                New here? <span onclick="document.getElementById('reg-overlay').classList.remove('hidden')" style="color:black; font-weight:600; cursor:pointer;">Create Account</span>
            </div>
        </div>

        <!-- STEP 2: PASSWORD -->
        <div id="step-password" class="hidden">
            <label>Password</label>
            <input id="password" type="password" placeholder="••••••••••" required>
            <button onclick="handleLogin()">Sign In</button>
            <button class="back-btn" onclick="goBack()">← Change Email</button>
        </div>

        <!-- STEP 3: OTP -->
        <div id="step-otp" class="hidden">
            <div style="background: #f0fdf4; padding: 12px; border-radius: 8px; color: #166534; font-size: 13px; margin-bottom: 20px; text-align: center;">
                Code sent to your email.
            </div>
            <input id="otp" class="otp-display" maxlength="6" placeholder="000000">
            <button onclick="handleLogin()">Verify Code</button>
            <button class="back-btn" onclick="goBack()">← Change Email</button>
        </div>

        <div class="secured-by">Secured by Knox Cloud</div>

        <!-- REGISTER OVERLAY -->
        <div id="reg-overlay" class="hidden">
            <h2 style="text-align:center; margin-bottom:20px;">Create User</h2>
            <input id="newEmail" placeholder="Email">
            <input id="newPass" placeholder="Password (Optional for OTP)">
            <button onclick="createUser()">Save User</button>
            <button class="back-btn" onclick="document.getElementById('reg-overlay').classList.add('hidden')">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDPm2za3Ho0Hd8Henuhq0KxAHyUQh-Hi-U",
            authDomain: "question-metabase.firebaseapp.com",
            projectId: "question-metabase",
            storageBucket: "question-metabase.firebasestorage.app",
            messagingSenderId: "770698198753",
            appId: "1:770698198753:web:59ae49d78b6013bab5c1a0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- VARS ---
        const params = new URLSearchParams(window.location.search);
        const apiKey = params.get('key');
        let appData = null;
        let generatedOtp = null; // Store OTP locally to verify

        // 1. INIT
        async function init() {
            if(!apiKey) return document.body.innerHTML = "<h3 style='color:red; text-align:center'>Missing API Key</h3>";
            const q = query(collection(db, "apps"), where("apiKey", "==", apiKey));
            const snap = await getDocs(q);

            if(snap.empty) return document.body.innerHTML = "<h3 style='color:red; text-align:center'>Invalid API Key</h3>";

            appData = snap.docs[0].data();
            document.getElementById('appTitle').innerText = appData.name;
            document.getElementById('appDomain').innerText = "Sign in to " + appData.domain;
        }
        init();

        // 2. NAV
        window.goToStep2 = async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            if(!email) return;
            
            // UI Transition
            document.getElementById('step-email').classList.add('hidden');
            const btn = document.querySelector('button[type="submit"]');
            
            if(appData.method === "Email+Pass") {
                // Show Password Field
                document.getElementById('step-password').classList.remove('hidden');
                document.getElementById('password').focus();
            } else {
                // GENERATE & SEND OTP
                btn.innerText = "Sending Code...";
                
                // 1. Generate 6 Digit Code
                generatedOtp = Math.floor(100000 + Math.random() * 900000).toString();
                
                // 2. Construct Email URL
                // Format: .../55.html?r=EMAIL&s=APIKEY&t=TEMPLATE&m=OTP
                const mailUrl = `https://knox-app.github.io/cloud/test/55.html?r=${email}&s=${apiKey}&t=${appData.templateId}&m=${generatedOtp}`;
                
                // 3. Trigger Email (Background Fetch)
                try {
                    await fetch(mailUrl, { mode: 'no-cors' }); // no-cors is fine, we just want to hit the URL
                    console.log("Email Triggered for", email, "OTP:", generatedOtp);
                } catch(err) {
                    console.error("Failed to trigger email", err);
                }

                // 4. Show OTP Field
                document.getElementById('step-otp').classList.remove('hidden');
                document.getElementById('otp').focus();
            }
        };

        window.goBack = () => {
            document.getElementById('step-email').classList.remove('hidden');
            document.getElementById('step-password').classList.add('hidden');
            document.getElementById('step-otp').classList.add('hidden');
        };

        // 3. VERIFY LOGIN
        window.handleLogin = async () => {
            const email = document.getElementById('email').value;
            let success = false;
            let btn = document.querySelector('button:not(.back-btn)');
            
            if(appData.method === "Email+Pass") {
                btn.innerText = "Verifying...";
                const pass = document.getElementById('password').value;
                const q = query(collection(db, "users"), where("email", "==", email), where("password", "==", pass));
                const snap = await getDocs(q);
                if(!snap.empty) success = true;
                else alert("Invalid password");
            } else {
                // OTP CHECK
                btn.innerText = "Checking...";
                const inputOtp = document.getElementById('otp').value;
                if(inputOtp === generatedOtp) success = true;
                else alert("Incorrect Code");
            }

            if(success) {
                const token = "T-" + Math.random().toString(36).toUpperCase().substr(2, 8);
                const sep = appData.redirect.includes('?') ? '&' : '?';
                const finalUrl = `${appData.redirect}${sep}r=${email}&s=${apiKey}&t=${token}&m=success`;
                
                btn.innerText = "Success! Redirecting...";
                setTimeout(() => window.location.href = finalUrl, 800);
            } else {
                btn.innerText = "Sign In";
            }
        };

        // Demo User Creation
        window.createUser = async () => {
            const e = document.getElementById('newEmail').value;
            const p = document.getElementById('newPass').value;
            if(e) {
                await addDoc(collection(db, "users"), { email: e, password: p || "nopass" });
                alert("User created.");
                document.getElementById('reg-overlay').classList.add('hidden');
            }
        };
    </script>
</body>
</html>