<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Login</title>
    <style>
        /* CSS Reset & Style - Same professional SaaS look */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: #f3f4f6; height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        
        .card { background: white; width: 100%; max-width: 400px; padding: 40px; border-radius: 20px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05), 0 8px 10px -6px rgba(0,0,0,0.01); border: 1px solid #e5e5e5; }
        
        .logo { width: 50px; height: 50px; background: #000; color: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 800; margin: 0 auto 20px auto; }
        
        h1 { font-size: 22px; font-weight: 700; text-align: center; color: #111; margin-bottom: 5px; }
        p.sub { text-align: center; color: #666; font-size: 14px; margin-bottom: 30px; }
        
        label { font-size: 11px; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-bottom: 6px; display: block; }
        
        input { width: 100%; padding: 14px; font-size: 16px; border: 1px solid #e5e5e5; border-radius: 10px; outline: none; transition: 0.2s; margin-bottom: 15px; }
        input:focus { border-color: #000; box-shadow: 0 0 0 3px rgba(0,0,0,0.05); }
        
        button { width: 100%; padding: 14px; background: #000; color: white; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; }
        button:hover { opacity: 0.8; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .otp-input { text-align: center; letter-spacing: 8px; font-size: 24px; font-family: monospace; font-weight: 700; }
        
        .hidden { display: none; }
        .back-link { display: block; text-align: center; margin-top: 15px; font-size: 12px; color: #666; cursor: pointer; }
        .back-link:hover { text-decoration: underline; color: #000; }
    </style>
</head>
<body>

    <div class="card">
        <div class="logo">K</div>
        <h1 id="appName">Loading...</h1>
        <p class="sub" id="appDomain">Secure Identity Provider</p>

        <!-- STEP 1: EMAIL -->
        <div id="view-email">
            <form onsubmit="handleEmailSubmit(event)">
                <label>Email Address</label>
                <input id="email" type="email" placeholder="name@work.com" required>
                <button id="btn-next">Continue</button>
            </form>
            <div style="text-align: center; margin-top: 20px; font-size: 12px; color: #999;">
                Secured by Knox Cloud
            </div>
        </div>

        <!-- STEP 2: PASSWORD (If applicable) -->
        <div id="view-password" class="hidden">
            <label>Enter Password</label>
            <input id="password" type="password" placeholder="••••••••">
            <button onclick="verifyPassword()">Sign In</button>
            <span class="back-link" onclick="location.reload()">← Change Email</span>
        </div>

        <!-- STEP 3: OTP (If applicable) -->
        <div id="view-otp" class="hidden">
            <div style="background: #f0fdf4; color: #166534; padding: 10px; font-size: 12px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                Code sent to <b id="displayEmail"></b>
            </div>
            
            <label>Verification Code</label>
            <input id="otp" class="otp-input" maxlength="6" placeholder="000000">
            <button onclick="verifyOtp()">Verify & Login</button>
            <span class="back-link" onclick="location.reload()">← Resend Code</span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG (Same as 1.html)
        const firebaseConfig = {
            apiKey: "AIzaSyDPm2za3Ho0Hd8Henuhq0KxAHyUQh-Hi-U",
            authDomain: "question-metabase.firebaseapp.com",
            projectId: "question-metabase",
            storageBucket: "question-metabase.firebasestorage.app",
            messagingSenderId: "770698198753",
            appId: "1:770698198753:web:59ae49d78b6013bab5c1a0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // STATE
        let appData = null;
        let generatedOtp = null;
        const params = new URLSearchParams(window.location.search);
        const apiKey = params.get('key');

        // INIT
        async function init() {
            if(!apiKey) return document.body.innerHTML = "<h1>Error: Missing API Key</h1>";
            
            const q = query(collection(db, "apps"), where("apiKey", "==", apiKey));
            const snap = await getDocs(q);
            
            if(snap.empty) return document.body.innerHTML = "<h1>Error: Invalid API Key</h1>";
            
            appData = snap.docs[0].data();
            document.getElementById('appName').innerText = appData.name;
            document.getElementById('appDomain').innerText = appData.domain;
        }
        init();

        // HANDLERS
        window.handleEmailSubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const btn = document.getElementById('btn-next');
            btn.innerText = "Processing...";

            document.getElementById('view-email').classList.add('hidden');

            if (appData.method === "Email+Pass") {
                // Show Password UI
                document.getElementById('view-password').classList.remove('hidden');
                document.getElementById('password').focus();
            } else {
                // OTP FLOW
                generatedOtp = Math.floor(100000 + Math.random() * 900000).toString();
                
                // --- TRIGGER OTP URL ---
                // Format: https://knox-app.github.io/cloud/test/55.html?r=<email>&s=<sender>&t=<template>=<otp>
                const baseUrl = "https://knox-app.github.io/cloud/test/55.html";
                const sender = appData.senderId || "DEFAULT";
                const template = appData.templateId || "DEFAULT";
                
                const sendUrl = `${baseUrl}?r=${email}&s=${sender}&t=${template}=${generatedOtp}`;
                
                console.log("Triggering OTP URL:", sendUrl);
                
                // Use fetch with no-cors to fire and forget (since we can't read response from another domain anyway)
                try {
                    await fetch(sendUrl, { mode: 'no-cors' });
                } catch (err) {
                    console.error("Failed to trigger OTP url", err);
                }

                // Show OTP UI
                document.getElementById('view-otp').classList.remove('hidden');
                document.getElementById('displayEmail').innerText = email;
                document.getElementById('otp').focus();
            }
        };

        window.verifyPassword = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            
            // In a real app, hash password. Here checking firestore 'users' collection for demo
            const q = query(collection(db, "users"), where("email", "==", email), where("password", "==", pass));
            const snap = await getDocs(q);

            if (!snap.empty) {
                finishLogin(email);
            } else {
                alert("Invalid Password");
            }
        };

        window.verifyOtp = () => {
            const inputOtp = document.getElementById('otp').value;
            if (inputOtp === generatedOtp) {
                const email = document.getElementById('email').value;
                finishLogin(email);
            } else {
                alert("Incorrect OTP");
            }
        };

        function finishLogin(email) {
            const token = "T-" + Math.random().toString(36).substr(2, 9).toUpperCase();
            
            // Construct Redirect URL
            const sep = appData.redirect.includes('?') ? '&' : '?';
            const finalUrl = `${appData.redirect}${sep}r=${email}&s=${apiKey}&t=${token}&m=success`;
            
            document.body.innerHTML = `
                <div style="text-align:center">
                    <h1 style="color:#166534">Success!</h1>
                    <p>Redirecting to ${appData.name}...</p>
                </div>
            `;
            setTimeout(() => window.location.href = finalUrl, 1000);
        }
    </script>
</body>
</html>