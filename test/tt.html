<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cloud Trigger Engine</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>
<body style="font-family:sans-serif; text-align:center; padding:40px; background:#f4f7f6;">
    <h3 id="status">Verifying Security Protocols...</h3>
    <p id="details" style="color:grey; font-size:12px;"></p>

    <script>
        if (window.__TRIGGERED__) { console.log("Halt"); } 
        else { window.__TRIGGERED__ = true; start(); }

        async function start() {
            const status = document.getElementById("status");
            const details = document.getElementById("details");

            try {
                const params = new URLSearchParams(location.search);
                const r = params.get("r"), s = params.get("s"), t = params.get("t"), m = params.get("m");
                
                if (!r || !s || !t || !m) throw new Error("Request Malformed: Missing parameters.");

                firebase.initializeApp({ apiKey: "AIzaSyDPm2za3Ho0Hd8Henuhq0KxAHyUQh-Hi-U", projectId: "question-metabase" });
                const db = firebase.firestore();
                emailjs.init("Yr9MutUoHOEONnFgn");

                // 1. PROJECT FETCH
                const apiSnap = await db.collection("api_keys").doc(s).get();
                if (!apiSnap.exists) throw new Error("Security Error: Invalid API Key.");
                const project = apiSnap.data();

                // 2. ðŸ›¡ï¸ DOMAIN SECURITY CHECK
                const referrer = document.referrer; // URL of the page that clicked the button
                if (!referrer || !referrer.includes(project.allowedDomain)) {
                    throw new Error("Unauthorized Origin: This domain is not allowed to trigger this API.");
                }

                // 3. ðŸ›¡ï¸ ANTI-SPAM CHECK (5 emails per 6 hours)
                const sixHoursAgo = Date.now() - (6 * 60 * 60 * 1000);
                const spamCheck = await db.collection("logs")
                    .where("receiver", "==", r)
                    .where("apiKey", "==", s)
                    .where("timestamp", ">", sixHoursAgo)
                    .get();

                if (spamCheck.size >= 5) {
                    throw new Error("Rate Limit Exceeded: 5 emails per 6 hours limit reached for " + r);
                }

                // 4. TEMPLATE FETCH & PROCESS
                const tempSnap = await db.collection("templates").doc(t).get();
                if (!tempSnap.exists) throw new Error("Template Not Found.");
                const template = tempSnap.data();
                const finalBody = template.html.replace(/{{code}}/g, m);

                // 5. DELIVERY
                let method = "Internal";
                const userSnap = await db.collection("users").doc(r).get();

                if (userSnap.exists) {
                    await db.collection("emails").add({
                        sender: project.companyName, receiver: r,
                        subject: template.subject, message: finalBody,
                        status: "inbox", timestamp: Date.now()
                    });
                } else {
                    method = "EmailJS";
                    await emailjs.send("service_qiyll9e", "template_vssk4uu", {
                        to_email: r, from_name: project.companyName,
                        subject: template.subject, message: finalBody
                    });
                }

                // 6. LOGGING
                await db.collection("logs").add({
                    projectName: project.companyName,
                    apiKey: s, receiver: r, method, timestamp: Date.now()
                });

                status.innerText = "Request Successful";
                status.style.color = "green";
                details.innerText = "Sent via " + method + " to " + r;

                // Hide sensitive data from URL
                window.history.replaceState({}, "", "5.html?session=verified");

            } catch (err) {
                status.innerText = "Security Block";
                status.style.color = "red";
                details.innerText = err.message;
            }
        }
    </script>
</body>
  </html>
