<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compose - Xperts Mail</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <!-- Libraries -->
    <!-- Firebase Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- EmailJS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #fff;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            border-bottom: 1px solid #f1f3f4;
            background: white;
        }
        .header-title {
            font-size: 20px;
            color: #202124;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f1f3f4;
            padding: 5px 15px 5px 5px;
            border-radius: 30px;
        }
        .user-profile img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
        .user-email { font-size: 13px; color: #5f6368; }

        /* Compose Area */
        .compose-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
        }

        .input-row {
            display: flex;
            border-bottom: 1px solid #f1f3f4;
            padding: 5px 0;
            align-items: center;
            position: relative;
        }
        .input-row label {
            color: #5f6368;
            width: 60px;
            font-size: 14px;
            padding-left: 10px;
        }
        .input-row input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 14px;
            padding: 8px;
        }
        .toggle-cc-bcc {
            position: absolute;
            right: 10px;
            font-size: 12px;
            color: #5f6368;
            cursor: pointer;
        }
        .toggle-cc-bcc:hover { text-decoration: underline; }

        .hidden { display: none !important; }

        #body-editor {
            flex: 1;
            border: none;
            outline: none;
            padding: 15px;
            font-size: 14px;
            resize: none;
            overflow-y: auto;
            font-family: 'Roboto', sans-serif;
        }

        /* Attachments Area */
        #attachment-area {
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .att-chip {
            display: flex;
            align-items: center;
            background: #f1f3f4;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 13px;
            width: 200px;
            justify-content: space-between;
        }
        .att-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
            color: #1a73e8;
            font-weight: 500;
        }
        .att-remove {
            cursor: pointer;
            color: #5f6368;
        }

        /* Footer Toolbar */
        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background: white;
            border-top: 1px solid #f1f3f4;
        }
        .send-group {
            display: flex;
            align-items: center;
            background: #1a73e8;
            border-radius: 20px;
            overflow: hidden;
        }
        .btn-send {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 10px 24px;
            font-weight: 500;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-send:hover { background: #1557b0; }
        
        .tools-right {
            display: flex;
            gap: 15px;
            color: #5f6368;
        }
        .icon-btn {
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 5px;
            border-radius: 50%;
        }
        .icon-btn:hover { background-color: #f1f3f4; }
        
        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .modal-header { font-weight: bold; margin-bottom: 15px; }
        .modal-option {
            padding: 10px;
            cursor: pointer;
            border-radius: 4px;
        }
        .modal-option:hover { background: #f1f3f4; }
        .date-picker { margin-top: 10px; width: 100%; padding: 8px; }
        
        .confidential-badge, .schedule-badge {
            background: #fff8e1;
            color: #f57f17;
            padding: 5px 10px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            border: 1px solid #ffe082;
            margin: 5px 15px;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<header>
    <div class="header-title">
        <span class="material-icons" style="color:#ea4335">mail</span> Compose
    </div>
    <div class="user-profile">
        <img id="uAvatar" src="" alt="Profile">
        <span id="uEmail" class="user-email"></span>
    </div>
</header>

<div class="compose-container">
    <div class="input-row">
        <label>To</label>
        <input type="email" id="toEmail" list="historySuggestions">
        <datalist id="historySuggestions"></datalist>
        <span class="toggle-cc-bcc" onclick="toggleCcBcc()">CC BCC</span>
    </div>
    
    <div class="input-row hidden" id="ccRow">
        <label>Cc</label>
        <input type="text" id="ccEmail">
    </div>
    
    <div class="input-row hidden" id="bccRow">
        <label>Bcc</label>
        <input type="text" id="bccEmail">
    </div>

    <div class="input-row">
        <label>Subject</label>
        <input type="text" id="subject">
    </div>

    <!-- Badges for special modes -->
    <div id="scheduleBadge" class="schedule-badge hidden">
        <span class="material-icons" style="font-size:16px">schedule</span> Scheduled: <span id="scheduleText"></span>
        <span class="material-icons" style="font-size:16px; margin-left:auto; cursor:pointer" onclick="clearSchedule()">close</span>
    </div>
    <div id="confidentialBadge" class="confidential-badge hidden">
        <span class="material-icons" style="font-size:16px">lock_clock</span> Confidential Mode: <span id="confidentialText"></span>
        <span class="material-icons" style="font-size:16px; margin-left:auto; cursor:pointer" onclick="clearConfidential()">close</span>
    </div>

    <textarea id="body-editor" placeholder="Write your email here..."></textarea>

    <div id="attachment-area"></div>
</div>

<div class="toolbar">
    <div class="send-group">
        <button class="btn-send" onclick="sendMail()">Send</button>
        <div style="border-left:1px solid rgba(0,0,0,0.1); padding: 10px; cursor:pointer; background:#1a73e8; color:white" onclick="showScheduleModal()">
            <span class="material-icons" style="font-size:18px">arrow_drop_down</span>
        </div>
    </div>

    <div class="tools-right">
        <!-- Attachment Input Hidden -->
        <input type="file" id="attInput" style="display:none" onchange="handleFileUpload(this)">
        
        <div class="icon-btn" onclick="document.getElementById('attInput').click()" title="Attach files">
            <span class="material-icons">attach_file</span>
        </div>
        <div class="icon-btn" onclick="showConfidentialModal()" title="Confidential mode">
            <span class="material-icons">lock_clock</span>
        </div>
        <div class="icon-btn" title="Insert Photo">
            <span class="material-icons">image</span>
        </div>
    </div>
</div>

<!-- Schedule Modal -->
<div id="scheduleModal" class="modal-overlay hidden">
    <div class="modal-box">
        <div class="modal-header">Schedule Send</div>
        <div class="modal-option" onclick="setSchedule('Tomorrow Morning')">Tomorrow Morning (8:00 AM)</div>
        <div class="modal-option" onclick="setSchedule('Tomorrow Evening')">Tomorrow Evening (5:00 PM)</div>
        <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
            <label style="font-size:12px;">Pick Date & Time</label>
            <input type="datetime-local" class="date-picker" id="customSchedule">
            <button class="btn-send" style="width:100%; margin-top:10px;" onclick="setSchedule('custom')">Set</button>
        </div>
        <div style="text-align:right; margin-top:10px; font-size:12px; cursor:pointer; color:#1a73e8" onclick="hideModals()">Cancel</div>
    </div>
</div>

<!-- Confidential Modal -->
<div id="confidentialModal" class="modal-overlay hidden">
    <div class="modal-box">
        <div class="modal-header">Confidential Mode</div>
        <p style="font-size:12px; color:#666">Recipients won't have the option to forward, copy, print, or download this email.</p>
        <div style="margin: 10px 0;">
            <label style="font-size:13px; display:block; margin-bottom:5px;">Set Expiration:</label>
            <select id="confidentialSelect" style="width:100%; padding:8px;">
                <option value="1 Hour">Expires in 1 Hour</option>
                <option value="1 Day">Expires in 1 Day</option>
                <option value="1 Week">Expires in 1 Week</option>
                <option value="1 Year">Expires in 1 Year</option>
            </select>
        </div>
        <button class="btn-send" style="width:100%" onclick="setConfidential()">Save</button>
        <div style="text-align:right; margin-top:10px; font-size:12px; cursor:pointer; color:#1a73e8" onclick="hideModals()">Cancel</div>
    </div>
</div>

<script>
    // --- Configs ---
    // User Metadata Config
    const authConfig = {
        apiKey: "AIzaSyDL7sPp-FkG59L-mRQ7BrCGgeKMhQC80iw",
        authDomain: "xperts-metadata.firebaseapp.com",
        projectId: "xperts-metadata",
        storageBucket: "xperts-metadata.firebasestorage.app",
        messagingSenderId: "514845910910",
        appId: "1:514845910910:web:5a2402130a97b5d749b52f",
        measurementId: "G-CQ5KWGJSZB"
    };

    // Mail Storage Config
    const mailConfig = {
        apiKey: "AIzaSyBnkCh8r_Ewx8lbr0RBB7i6M-xdABphd9w",
        authDomain: "initialisation-cfb78.firebaseapp.com",
        projectId: "initialisation-cfb78",
        storageBucket: "initialisation-cfb78.firebasestorage.app",
        messagingSenderId: "217554560023",
        appId: "1:217554560023:web:5ca34ac80acd8aba872852",
        measurementId: "G-S9T0PWGZQX"
    };

    const supabaseUrl = 'https://bbuqlrtjkhsddxshwmxk.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJidXFscnRqa2hzZGR4c2h3bXhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMTQ1ODMsImV4cCI6MjA3OTc5MDU4M30.e-bZCRs7aEauXy3arrqgVz0zV2N26jU25Jv0plXq23c';
    
    // EmailJS
    const emailJsService = "service_5hs4mqf";
    const emailJsTemplate = "template_rm8jf2c";
    const emailJsKey = "Yr9MutUoHOEONnFgn";

    // --- Initialization ---
    // Init Multiple Firebase Apps
    const appAuth = firebase.initializeApp(authConfig, "authApp");
    const appMail = firebase.initializeApp(mailConfig, "mailApp");
    
    const dbUsers = firebase.firestore(appAuth); // Read Users
    const dbMail = firebase.firestore(appMail);  // Write Emails

    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    (function(){
        emailjs.init(emailJsKey);
    })();

    // --- State & DOM ---
    let currentUser = JSON.parse(localStorage.getItem('xpertsUser'));
    if(!currentUser) window.location.href = '1.html';

    // Set Header
    document.getElementById('uEmail').innerText = currentUser.email;
    document.getElementById('uAvatar').src = currentUser.profilePic || 'https://via.placeholder.com/32';

    // Populate suggestions
    loadSuggestions();

    let attachments = [];
    let scheduleData = null;
    let confidentialData = null;

    // --- Functions ---

    function toggleCcBcc() {
        document.getElementById('ccRow').classList.toggle('hidden');
        document.getElementById('bccRow').classList.toggle('hidden');
    }

    // Attachment Handler
    async function handleFileUpload(input) {
        if(input.files.length > 0) {
            const file = input.files[0];
            const timestamp = Date.now();
            const filePath = `uploads/${timestamp}_${file.name}`;
            
            // UI Placeholder
            addAttachmentUI(file.name, '#', true);

            // Upload to Supabase
            const { data, error } = await supabase.storage.from('files').upload(filePath, file);
            
            if(error) {
                console.error(error);
                alert("Upload failed. Ensure bucket 'files' exists.");
                // Remove last UI element
                document.getElementById('attachment-area').lastChild.remove();
            } else {
                const { data: publicUrlData } = supabase.storage.from('files').getPublicUrl(filePath);
                attachments.push({
                    name: file.name,
                    url: publicUrlData.publicUrl
                });
                // Update UI link
                updateLastAttachmentLink(publicUrlData.publicUrl);
            }
        }
    }

    function addAttachmentUI(name, url, isLoading) {
        const div = document.createElement('div');
        div.className = 'att-chip';
        div.innerHTML = `
            <div style="display:flex; align-items:center; gap:5px">
                <span class="material-icons" style="font-size:16px; color:#ea4335">description</span>
                <a href="${url}" target="_blank" class="att-name" style="text-decoration:none">${name}</a>
            </div>
            <span class="material-icons att-remove" style="font-size:16px" onclick="removeAttachment(this, '${name}')">close</span>
        `;
        document.getElementById('attachment-area').appendChild(div);
    }

    function updateLastAttachmentLink(url) {
        const links = document.querySelectorAll('.att-name');
        if(links.length > 0) links[links.length - 1].href = url;
    }

    function removeAttachment(el, name) {
        el.parentElement.remove();
        attachments = attachments.filter(a => a.name !== name);
    }

    // Schedule Logic
    function showScheduleModal() {
        document.getElementById('scheduleModal').classList.remove('hidden');
    }
    function setSchedule(type) {
        if(type === 'custom') {
            const val = document.getElementById('customSchedule').value;
            if(!val) return;
            scheduleData = val;
            document.getElementById('scheduleText').innerText = new Date(val).toLocaleString();
        } else {
            scheduleData = type; // Logic to calculate date would go here
            document.getElementById('scheduleText').innerText = type;
        }
        document.getElementById('scheduleBadge').classList.remove('hidden');
        hideModals();
    }
    function clearSchedule() {
        scheduleData = null;
        document.getElementById('scheduleBadge').classList.add('hidden');
    }

    // Confidential Logic
    function showConfidentialModal() {
        document.getElementById('confidentialModal').classList.remove('hidden');
    }
    function setConfidential() {
        const val = document.getElementById('confidentialSelect').value;
        confidentialData = val;
        document.getElementById('confidentialText').innerText = val;
        document.getElementById('confidentialBadge').classList.remove('hidden');
        hideModals();
    }
    function clearConfidential() {
        confidentialData = null;
        document.getElementById('confidentialBadge').classList.add('hidden');
    }

    function hideModals() {
        document.getElementById('scheduleModal').classList.add('hidden');
        document.getElementById('confidentialModal').classList.add('hidden');
    }

    // Suggestions Logic
    async function loadSuggestions() {
        // Simple implementation: Query dbMail for emails sent by this encKey to get unique recipients
        // For performance in this demo, just hardcoding logic or empty
        // In real app: maintain a 'contacts' collection
    }

    // Send Logic
    async function sendMail() {
        const to = document.getElementById('toEmail').value;
        const subject = document.getElementById('subject').value;
        const body = document.getElementById('body-editor').value;
        const cc = document.getElementById('ccEmail').value;
        const bcc = document.getElementById('bccEmail').value;

        if(!to) { alert('Recipient email required'); return; }

        const btn = document.querySelector('.btn-send');
        btn.innerText = 'Sending...';
        btn.disabled = true;

        try {
            // 1. Check Internal vs External
            const userCheck = await dbUsers.collection('users').where('email', '==', to).get();
            const isInternal = !userCheck.empty;

            // 2. Prepare Data
            const emailData = {
                senderEncKey: currentUser.encKey,
                senderEmail: currentUser.email,
                receiverEmail: to,
                subject: subject,
                body: body,
                cc: cc,
                bcc: bcc,
                attachments: attachments,
                type: isInternal ? 'Internal' : 'External',
                scheduled: scheduleData,
                confidential: confidentialData,
                timestamp: new Date().toISOString()
            };

            // 3. If External, use EmailJS
            if(!isInternal) {
                // Prepare string for attachments links
                const attLinks = attachments.map(a => a.url).join('\n');
                const templateParams = {
                    to_email: to,
                    from_name: currentUser.fname + " " + currentUser.lname,
                    subject: subject,
                    message: body,
                    attachments_links: attLinks,
                    reply_to: currentUser.email
                };

                await emailjs.send(emailJsService, emailJsTemplate, templateParams);
                console.log("EmailJS Sent");
            }

            // 4. Store in Firestore (App 2)
            await dbMail.collection('emails').add(emailData);

            alert(`Email Sent Successfully (${isInternal ? 'Internal' : 'External'})`);
            window.location.reload();

        } catch (error) {
            console.error(error);
            alert("Error sending email: " + error.message);
            btn.innerText = 'Send';
            btn.disabled = false;
        }
    }

</script>
</body>
</html>
