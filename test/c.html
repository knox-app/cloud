<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Compose V</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

    <!-- Firebase SDK (v8) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; margin: 0; background-color: #fff; overflow-x: hidden; color: #1f1f1f; }
        
        /* HEADER */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; background: white;
            position: sticky; top: 0; z-index: 50;
        }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .header-right { display: flex; align-items: center; gap: 24px; }
        .icon-btn { cursor: pointer; color: #444746; font-size: 24px; user-select: none; }
        .send-icon { color: #0b57d0; transform: rotate(-20deg) translateY(-2px); font-size: 26px; }
        .title-text { font-size: 20px; color: #444746; }

        /* FORM ROWS */
        .input-row {
            display: flex; align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            position: relative;
            min-height: 50px;
        }
        .from-row { border-bottom: none; padding-bottom: 5px; }
        
        .label-text { 
            color: #5f6368; 
            font-size: 16px; 
            width: 50px;
            flex-shrink: 0;
        }
        
        .from-chip {
            display: flex; align-items: center; gap: 8px;
            background: #e8f0fe; padding: 4px 12px 4px 4px; 
            border-radius: 20px; font-size: 14px; color: #444746;
        }
        .from-chip img { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; }
        
        input {
            flex-grow: 1; border: none; font-size: 16px; outline: none; padding: 0;
            font-family: 'Roboto', sans-serif;
        }
        
        .expand-icon { margin-left: auto; cursor: pointer; color: #5f6368; font-size: 24px; transition: 0.2s; }
        
        /* SUGGESTIONS */
        #suggestions-box {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 100; max-height: 250px; overflow-y: auto; display: none;
        }
        .suggestion-item {
            padding: 12px 15px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-bottom: 1px solid #f5f5f5;
        }
        .suggestion-item:hover { background: #f5f5f5; }
        .suggestion-item img { width: 36px; height: 36px; border-radius: 50%; object-fit: cover;}
        
        /* ATTACHMENTS */
        #attachment-area { 
            padding: 5px 15px; display: flex; flex-wrap: wrap; gap: 8px; 
        }
        .att-chip {
            display: flex; align-items: center; gap: 6px;
            border: 1px solid #dadce0; border-radius: 16px;
            padding: 6px 12px; font-size: 13px; color: #444746;
        }
        .att-loading { opacity: 0.6; }

        /* BODY */
        textarea {
            width: 100%; min-height: 400px; border: none; padding: 15px;
            font-size: 16px; font-family: 'Roboto', sans-serif; resize: none; outline: none;
        }

        /* MODALS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); display: none; 
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; width: 85%; max-width: 320px; border-radius: 8px;
            padding: 8px 0; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            animation: popIn 0.2s ease-out;
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; }}
        
        .modal-header { padding: 16px 24px 10px; font-size: 18px; font-weight: 500; }
        .modal-item { 
            padding: 14px 24px; font-size: 16px; color: #1f1f1f; cursor: pointer; display: flex; justify-content: space-between;
        }
        .modal-item:hover { background: #f5f5f5; }
        .modal-item span { color: #5f6368; font-size: 14px; }
        
        .modal-actions { padding: 10px 24px 16px; text-align: right; display: flex; justify-content: flex-end; gap: 20px;}
        .modal-btn { color: #0b57d0; font-weight: 500; cursor: pointer; font-size: 14px;}

        /* DATE PICKER */
        .picker-container { padding: 0 24px 10px; display: flex; flex-direction: column; gap: 15px;}
        .picker-input { border: 1px solid #ccc; padding: 10px; border-radius: 4px; font-family: inherit;}

        /* MENU */
        .menu-dropdown {
            position: absolute; top: 50px; right: 10px; background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); border-radius: 4px; display: none; z-index: 500;
            width: 200px; padding: 5px 0;
        }

        /* TOAST */
        #toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #323232; color: white; padding: 12px 24px; border-radius: 24px;
            font-size: 14px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 2000;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <span class="material-icons-outlined icon-btn" onclick="history.back()">arrow_back</span>
            <span class="title-text">Compose</span>
        </div>
        <div class="header-right">
            <label for="att-input">
                <span class="material-icons-outlined icon-btn" style="transform: rotate(45deg);">attach_file</span>
            </label>
            <input type="file" id="att-input" hidden multiple onchange="handleAttachment(this)">
            
            <span class="material-icons-outlined icon-btn send-icon" onclick="sendEmail()">send</span>
            <span class="material-icons-outlined icon-btn" onclick="toggleMenu()">more_vert</span>
        </div>
    </div>

    <!-- Kebab Menu -->
    <div class="menu-dropdown" id="main-menu">
        <div class="modal-item" onclick="openScheduleModal()">Schedule send</div>
        <div class="modal-item" onclick="openConfidentialModal()">Confidential mode</div>
    </div>

    <!-- Fields -->
    <div class="input-row from-row">
        <div class="label-text">From</div>
        <div class="from-chip" id="from-display">
            <!-- JS Injected -->
            <div style="width:24px; height:24px; background:#ccc; border-radius:50%"></div>
            <span>Loading...</span>
        </div>
        <div style="flex-grow:1"></div>
    </div>

    <div class="input-row">
        <div class="label-text">To</div>
        <input type="text" id="to-input" onkeyup="handleSuggestions(this.value)" autocomplete="off">
        <span class="material-icons-outlined expand-icon" id="toggle-cc" onclick="toggleCcBcc()">expand_more</span>
        <div id="suggestions-box"></div>
    </div>

    <div class="input-row" id="cc-row" style="display:none;">
        <div class="label-text">Cc</div>
        <input type="text" id="cc-input">
    </div>

    <div class="input-row" id="bcc-row" style="display:none;">
        <div class="label-text">Bcc</div>
        <input type="text" id="bcc-input">
    </div>

    <div class="input-row">
        <input type="text" id="subject-input" placeholder="Subject">
    </div>

    <div id="attachment-area"></div>

    <textarea id="body-input" placeholder="Compose email"></textarea>

    <!-- UI MODALS -->
    
    <!-- Schedule Modal -->
    <div class="modal-overlay" id="schedule-modal">
        <div class="modal-content">
            <div class="modal-header">Schedule send</div>
            <div class="modal-item" onclick="setSchedule('Tomorrow Morning', '8:00 AM')">Tomorrow morning <span>8:00 AM</span></div>
            <div class="modal-item" onclick="setSchedule('Tomorrow Afternoon', '1:00 PM')">Tomorrow afternoon <span>1:00 PM</span></div>
            <div class="modal-item" onclick="setSchedule('Monday Morning', '8:00 AM')">Monday morning <span>8:00 AM</span></div>
            <div class="modal-item" onclick="openDatePicker()">Pick date & time</div>
            <div class="modal-actions">
                <div class="modal-btn" onclick="closeModals()">Cancel</div>
            </div>
        </div>
    </div>

    <!-- Date Picker Modal -->
    <div class="modal-overlay" id="date-picker-modal">
        <div class="modal-content">
            <div class="modal-header">Pick date & time</div>
            <div class="picker-container">
                <input type="date" id="custom-date" class="picker-input">
                <input type="time" id="custom-time" class="picker-input">
            </div>
            <div class="modal-actions">
                <div class="modal-btn" onclick="closeModals()">Cancel</div>
                <div class="modal-btn" onclick="confirmCustomSchedule()">Schedule send</div>
            </div>
        </div>
    </div>

    <!-- Confidential Modal -->
    <div class="modal-overlay" id="confidential-modal">
        <div class="modal-content">
            <div class="modal-header">Confidential Mode</div>
            <div class="modal-item" onclick="setConfidential('1 Hour')">Expires in 1 Hour</div>
            <div class="modal-item" onclick="setConfidential('1 Day')">Expires in 1 Day</div>
            <div class="modal-item" onclick="setConfidential('1 Week')">Expires in 1 Week</div>
            <div class="modal-item" onclick="setConfidential('1 Year')">Expires in 1 Year</div>
            <div class="modal-actions">
                <div class="modal-btn" onclick="closeModals()">Cancel</div>
            </div>
        </div>
    </div>

    <div id="toast">Sent</div>

<script>
    // --- 1. CONFIGURATION ---

    // USER DB (Authentication & Search)
    const configUser = {
        apiKey: "AIzaSyDL7sPp-FkG59L-mRQ7BrCGgeKMhQC80iw",
        authDomain: "xperts-metadata.firebaseapp.com",
        projectId: "xperts-metadata",
        storageBucket: "xperts-metadata.firebasestorage.app",
        messagingSenderId: "514845910910",
        appId: "1:514845910910:web:5a2402130a97b5d749b52f"
    };

    // EMAIL DB (Storage)
    const configEmail = {
        apiKey: "AIzaSyBnkCh8r_Ewx8lbr0RBB7i6M-xdABphd9w",
        authDomain: "initialisation-cfb78.firebaseapp.com",
        projectId: "initialisation-cfb78",
        storageBucket: "initialisation-cfb78.firebasestorage.app",
        messagingSenderId: "217554560023",
        appId: "1:217554560023:web:5ca34ac80acd8aba872852"
    };

    // Initialize Multiple Firebase Apps
    const appUser = firebase.initializeApp(configUser, "appUser");
    const appEmail = firebase.initializeApp(configEmail, "appEmail");

    const dbUser = appUser.firestore();
    const dbEmail = appEmail.firestore();

    // Supabase
    const sbUrl = 'https://bbuqlrtjkhsddxshwmxk.supabase.co';
    const sbKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJidXFscnRqa2hzZGR4c2h3bXhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMTQ1ODMsImV4cCI6MjA3OTc5MDU4M30.e-bZCRs7aEauXy3arrqgVz0zV2N26jU25Jv0plXq23c';
    const supabase = window.supabase.createClient(sbUrl, sbKey);

    // EmailJS
    emailjs.init("Yr9MutUoHOEONnFgn");

    // --- 2. STATE ---
    let attachmentsList = [];
    let scheduleData = null;
    let confidentialData = "None";
    const userEmail = localStorage.getItem("userEmail");
    const userKey = localStorage.getItem("userKey");
    let userProfilePic = "https://via.placeholder.com/30";

    // --- 3. INIT ---
    window.onload = async () => {
        if (!userEmail) { window.location.href = "1.html"; return; }

        try {
            const snap = await dbUser.collection("users").where("email", "==", userEmail).get();
            if (!snap.empty) {
                userProfilePic = snap.docs[0].data().photoURL;
                document.getElementById('from-display').innerHTML = `
                    <img src="${userProfilePic}" onerror="this.src='https://via.placeholder.com/30'">
                    <span>${userEmail}</span>
                `;
            }
        } catch (e) {
            console.error(e);
            document.getElementById('from-display').innerText = userEmail;
        }
    };

    // --- 4. UI LOGIC ---
    function toggleMenu() {
        const m = document.getElementById('main-menu');
        m.style.display = m.style.display === 'block' ? 'none' : 'block';
    }

    function toggleCcBcc() {
        const cc = document.getElementById('cc-row');
        const bcc = document.getElementById('bcc-row');
        const icon = document.getElementById('toggle-cc');
        
        const isVisible = cc.style.display !== 'none';
        cc.style.display = isVisible ? 'none' : 'flex';
        bcc.style.display = isVisible ? 'none' : 'flex';
        icon.innerText = isVisible ? 'expand_more' : 'expand_less';
    }

    function closeModals() {
        document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none');
        document.getElementById('main-menu').style.display = 'none';
    }

    // Suggestions
    async function handleSuggestions(val) {
        const box = document.getElementById('suggestions-box');
        if (val.length < 2) { box.style.display = 'none'; return; }

        try {
            // Note: Firestore basic search. In production, use Algolia/Typesense for partial match
            const snap = await dbUser.collection("users")
                .where("email", ">=", val)
                .where("email", "<=", val + '\uf8ff')
                .limit(5)
                .get();
            
            box.innerHTML = '';
            if (!snap.empty) {
                box.style.display = 'block';
                snap.forEach(doc => {
                    const d = doc.data();
                    const el = document.createElement('div');
                    el.className = 'suggestion-item';
                    el.innerHTML = `<img src="${d.photoURL}"><div>${d.firstName} ${d.lastName}<br><small style="color:#666">${d.email}</small></div>`;
                    el.onclick = () => {
                        document.getElementById('to-input').value = d.email;
                        box.style.display = 'none';
                    };
                    box.appendChild(el);
                });
            } else { box.style.display = 'none'; }
        } catch (e) { console.error(e); }
    }

    // Attachments
    async function handleAttachment(input) {
        const files = input.files;
        if (files.length === 0) return;
        const area = document.getElementById('attachment-area');

        for (let file of files) {
            const id = Date.now();
            const chip = document.createElement('div');
            chip.className = 'att-chip att-loading';
            chip.id = `chip-${id}`;
            chip.innerHTML = `<span>Uploading...</span>`;
            area.appendChild(chip);

            const fileName = `${id}_${file.name.replace(/\s/g, '')}`;
            const { error } = await supabase.storage.from('attachments').upload(fileName, file);

            if (error) {
                chip.remove();
                showToast("Upload Failed: " + file.name);
            } else {
                const { data } = supabase.storage.from('attachments').getPublicUrl(fileName);
                attachmentsList.push({ name: file.name, url: data.publicUrl });
                
                chip.classList.remove('att-loading');
                chip.innerHTML = `
                    <span class="material-icons-outlined" style="font-size:16px">description</span>
                    ${file.name.length > 15 ? file.name.substring(0,12)+'...' : file.name}
                    <span class="material-icons-outlined" style="cursor:pointer; font-size:16px" onclick="removeAtt(${id}, '${file.name}')">close</span>
                `;
            }
        }
    }

    function removeAtt(id, name) {
        document.getElementById(`chip-${id}`).remove();
        attachmentsList = attachmentsList.filter(a => a.name !== name);
    }

    // Scheduling & Confidential
    function openScheduleModal() { closeModals(); document.getElementById('schedule-modal').style.display = 'flex'; }
    function openDatePicker() { document.getElementById('schedule-modal').style.display = 'none'; document.getElementById('date-picker-modal').style.display = 'flex'; }
    function openConfidentialModal() { closeModals(); document.getElementById('confidential-modal').style.display = 'flex'; }

    function setSchedule(title, timeDesc) {
        scheduleData = `${title} (${timeDesc})`;
        closeModals();
        showToast("Scheduled: " + scheduleData);
    }

    function confirmCustomSchedule() {
        const d = document.getElementById('custom-date').value;
        const t = document.getElementById('custom-time').value;
        if(d && t) {
            setSchedule(d, t);
        } else {
            alert("Please pick date and time");
        }
    }

    function setConfidential(val) {
        confidentialData = val;
        closeModals();
        showToast("Confidential: " + val);
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.opacity = '1';
        setTimeout(() => t.style.opacity = '0', 3000);
    }

    // --- 5. SEND LOGIC ---
    async function sendEmail() {
        const to = document.getElementById('to-input').value;
        const cc = document.getElementById('cc-input').value;
        const bcc = document.getElementById('bcc-input').value;
        const sub = document.getElementById('subject-input').value;
        const body = document.getElementById('body-input').value;

        if (!to) { showToast("Recipient required"); return; }

        showToast("Sending...");

        // 1. Check if Recipient is Internal
        let isInternal = false;
        try {
            const q = await dbUser.collection("users").where("email", "==", to).get();
            isInternal = !q.empty;
        } catch (e) { console.error("User check failed", e); }

        const emailPayload = {
            senderEmail: userEmail,
            senderEncKey: userKey,
            receiverEmail: to,
            cc: cc,
            bcc: bcc,
            subject: sub,
            body: body,
            attachments: attachmentsList, // Array of {name, url}
            schedule: scheduleData || "Now",
            confidentialMode: confidentialData,
            type: isInternal ? "Internal" : "External",
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            // 2. Store in Email Database (Always)
            await dbEmail.collection("emails").add(emailPayload);

            // 3. If External -> Send via EmailJS
            if (!isInternal) {
                // Formatting attachments for plain text email
                const links = attachmentsList.map(a => `${a.name}: ${a.url}`).join("\n");
                
                await emailjs.send("service_5hs4mqf", "template_rm8jf2c", {
                    to_email: to,
                    from_name: userEmail,
                    subject: sub,
                    message: body + (links ? "\n\nAttachments:\n" + links : ""),
                    sender_email: userEmail
                });
                showToast("Sent via External Gateway");
            } else {
                showToast("Sent (Internal Encrypted)");
            }

            // Reset
            setTimeout(() => location.reload(), 2000);

        } catch (e) {
            console.error(e);
            showToast("Error sending message");
        }
    }
</script>
</body>
</html>
