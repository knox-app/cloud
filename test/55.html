<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Processing Trigger...</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>
<body style="font-family: sans-serif; text-align: center; padding-top: 50px; background: #f0f2f5;">
    
    <div style="background: white; display: inline-block; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 500px;">
        <h2 id="status">Verifying Request...</h2>
        <p id="details" style="color: #666;"></p>
        <div id="error-box" style="margin-top:20px; color: red; font-size: 13px; text-align: left; background: #fff1f0; padding: 10px; border-radius: 5px; display: none; border: 1px solid #ffa39e;"></div>
    </div>

    <script>
        // 1. Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDPm2za3Ho0Hd8Henuhq0KxAHyUQh-Hi-U",
            projectId: "question-metabase",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 2. EmailJS Init (Corrected Key)
        emailjs.init("Yr9MutUoHOEONnFgn");

        async function startProcess() {
            const status = document.getElementById('status');
            const details = document.getElementById('details');
            const errBox = document.getElementById('error-box');

            const params = new URLSearchParams(window.location.search);
            const r = params.get('r'); // vinayaknigam196@gmail.com
            const s = params.get('s'); // SK-80AT4XJ33K2
            const t = params.get('t'); // T-S7LSZ
            const m = params.get('m'); // 123

            if (!r || !s || !t) {
                status.innerText = "Invalid URL";
                details.innerText = "Parameters r, s, and t are required.";
                return;
            }

            try {
                // Step A: Fetch Key & Template from Firestore
                console.log("Fetching data for:", s, t);
                const [keyDoc, tempDoc] = await Promise.all([
                    db.collection("api_keys").doc(s).get(),
                    db.collection("templates").doc(t).get()
                ]);

                if (!keyDoc.exists) throw new Error("API Key (s) not found in Database.");
                if (!tempDoc.exists) throw new Error("Template (t) not found in Database.");

                const company = keyDoc.data().companyName;
                const template = tempDoc.data();
                const finalHtml = template.html.replace(/{{code}}/g, m || "");

                // Step B: Wipe URL for security
                const session = btoa(`r=${r}&t=${t}`);
                window.history.replaceState({}, '', '5.html?session=' + session.substring(0,10));

                // Step C: Check if user exists in your Firestore Users
                const userDoc = await db.collection("users").doc(r).get();

                if (userDoc.exists) {
                    // Send to Internal Inbox
                    await db.collection("emails").add({
                        sender: company,
                        receiver: r,
                        subject: template.subject || "New Message",
                        message: finalHtml,
                        status: 'inbox',
                        timestamp: Date.now()
                    });
                    status.innerText = "Success!";
                    details.innerText = "Message delivered to Internal Inbox.";
                    status.style.color = "green";
                } else {
                    // Step D: Send via EmailJS (The External Fallback)
                    status.innerText = "Sending External...";
                    
                    const emailParams = {
                        to_email: r,
                        from_name: company,
                        subject: template.subject || "Notification",
                        message: finalHtml
                    };

                    emailjs.send("service_qiyll9e", "template_vssk4uu", emailParams)
                        .then(() => {
                            status.innerText = "Sent Successfully!";
                            details.innerText = "User not in DB. Email delivered via EmailJS.";
                            status.style.color = "green";
                        })
                        .catch((err) => {
                            status.innerText = "EmailJS Error (400)";
                            status.style.color = "red";
                            errBox.style.display = "block";
                            errBox.innerHTML = `<strong>Reason:</strong> ${err.text || JSON.stringify(err)}<br><br>Check your EmailJS Dashboard Settings.`;
                        });
                }

            } catch (e) {
                status.innerText = "System Error";
                details.innerText = e.message;
                status.style.color = "red";
            }
        }

        window.onload = startProcess;
    </script>
</body>
</html>
