<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trigger Engine - Secure</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>
<body style="font-family:sans-serif; text-align:center; padding:40px">
    <h3 id="status">Verifying Security Policy...</h3>

    <script>
        if (window.__TRIGGERED__) { console.log("Halt"); } 
        else { window.__TRIGGERED__ = true; start(); }

        async function start() {
            const status = document.getElementById("status");
            try {
                const p = new URLSearchParams(location.search);
                const r = p.get("r"), s = p.get("s"), t = p.get("t"), m = p.get("m");
                if (!r || !s || !t || !m) throw new Error("Param Error");

                firebase.initializeApp({ apiKey: "AIzaSyDPm2za3Ho0Hd8Henuhq0KxAHyUQh-Hi-U", projectId: "question-metabase" });
                const db = firebase.firestore();
                emailjs.init("Yr9MutUoHOEONnFgn");

                // --- ðŸ›¡ï¸ SECURITY BLOCK LOGIC ---
                // Query logs for: Same Email (r) AND Same Template (t) in last 6 hours
                const sixHoursAgo = Date.now() - (6 * 60 * 60 * 1000);
                const spamCheck = await db.collection("logs")
                    .where("receiver", "==", r)
                    .where("templateId", "==", t)
                    .where("timestamp", ">", sixHoursAgo)
                    .get();

                if (spamCheck.size >= 5) {
                    throw new Error("Security Block: Too many emails to " + r + ". Try again in 6 hours.");
                }
                // ------------------------------

                const apiSnap = await db.collection("api_keys").doc(s).get();
                if (!apiSnap.exists) throw new Error("Invalid API Key");
                const project = apiSnap.data();

                const tempSnap = await db.collection("templates").doc(t).get();
                if (!tempSnap.exists) throw new Error("Template Missing");
                const template = tempSnap.data();

                const body = template.html.replace(/{{code}}/g, m);

                let method = "Internal";
                const userSnap = await db.collection("users").doc(r).get();

                if (userSnap.exists) {
                    await db.collection("emails").add({
                        sender: project.companyName, receiver: r,
                        subject: template.subject, message: body,
                        status: "inbox", timestamp: Date.now()
                    });
                } else {
                    method = "EmailJS";
                    await emailjs.send("service_qiyll9e", "template_vssk4uu", {
                        to_email: r, from_name: project.companyName,
                        subject: template.subject, message: body
                    });
                }

                // Log the attempt (including templateId for the security check)
                await db.collection("logs").add({
                    projectName: project.companyName,
                    apiKey: s,
                    templateId: t, // Added for security filtering
                    receiver: r,
                    method,
                    timestamp: Date.now()
                });

                status.innerText = "Processed via " + method;
                status.style.color = "green";

            } catch (err) {
                status.innerText = err.message;
                status.style.color = "red";
            }
        }
    </script>
</body>
</html>
