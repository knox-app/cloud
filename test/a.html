<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xperts Mail - Authentication</title>
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 400px;
            text-align: center;
        }
        .logo {
            color: #ea4335;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            flex: 1;
            padding: 10px;
            cursor: pointer;
            font-weight: 500;
            color: #5f6368;
        }
        .tab.active {
            color: #1a73e8;
            border-bottom: 3px solid #1a73e8;
        }
        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            text-align: left;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        label {
            font-size: 12px;
            color: #5f6368;
            margin-bottom: 4px;
        }
        input, select {
            padding: 10px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 14px;
        }
        input:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 1px #1a73e8;
        }
        .btn {
            background-color: #1a73e8;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 10px;
        }
        .btn:hover {
            background-color: #1557b0;
        }
        .hidden { display: none; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1a73e8;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
            display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div class="logo">
        <span class="material-icons">mail</span> Xperts Mail
    </div>
    
    <div class="tabs">
        <div class="tab active" onclick="switchTab('login')">Login</div>
        <div class="tab" onclick="switchTab('signup')">Sign Up</div>
    </div>

    <!-- Login Form -->
    <form id="loginForm">
        <div class="form-group">
            <label>Email ID</label>
            <input type="email" id="loginEmail" required>
        </div>
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="loginPassword" required>
        </div>
        <div class="loader" id="loginLoader"></div>
        <button type="submit" class="btn">Login</button>
    </form>

    <!-- Signup Form -->
    <form id="signupForm" class="hidden">
        <div style="display:flex; gap:10px;">
            <div class="form-group" style="flex:1">
                <label>First Name</label>
                <input type="text" id="fname" required>
            </div>
            <div class="form-group" style="flex:1">
                <label>Last Name</label>
                <input type="text" id="lname" required>
            </div>
        </div>
        <div class="form-group">
            <label>Profile Picture</label>
            <input type="file" id="profilePic" accept="image/*" required>
        </div>
        <div class="form-group">
            <label>Date of Birth</label>
            <input type="date" id="dob" required>
        </div>
        <div class="form-group">
            <label>Gender</label>
            <select id="gender" required>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Prefer not to say">Prefer not to say</option>
            </select>
        </div>
        <div class="form-group">
            <label>Email ID</label>
            <input type="email" id="regEmail" required>
        </div>
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="regPassword" required>
        </div>
        <div class="loader" id="signupLoader"></div>
        <button type="submit" class="btn">Create Account</button>
    </form>
</div>

<script>
    // --- Configuration ---
    const authConfig = {
        apiKey: "AIzaSyDL7sPp-FkG59L-mRQ7BrCGgeKMhQC80iw",
        authDomain: "xperts-metadata.firebaseapp.com",
        projectId: "xperts-metadata",
        storageBucket: "xperts-metadata.firebasestorage.app",
        messagingSenderId: "514845910910",
        appId: "1:514845910910:web:5a2402130a97b5d749b52f",
        measurementId: "G-CQ5KWGJSZB"
    };

    const supabaseUrl = 'https://bbuqlrtjkhsddxshwmxk.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJidXFscnRqa2hzZGR4c2h3bXhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMTQ1ODMsImV4cCI6MjA3OTc5MDU4M30.e-bZCRs7aEauXy3arrqgVz0zV2N26jU25Jv0plXq23c';
    const supabase = showSupabaseClient(); // Helper to init supabase

    function showSupabaseClient() {
        return window.supabase.createClient(supabaseUrl, supabaseKey);
    }

    // Initialize Firebase Auth App (Metadata Store)
    const app = firebase.initializeApp(authConfig);
    const db = firebase.firestore(app);

    // --- Logic ---

    function switchTab(tab) {
        if(tab === 'login') {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('signupForm').classList.add('hidden');
            document.querySelectorAll('.tab')[0].classList.add('active');
            document.querySelectorAll('.tab')[1].classList.remove('active');
        } else {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
            document.querySelectorAll('.tab')[0].classList.remove('active');
            document.querySelectorAll('.tab')[1].classList.add('active');
        }
    }

    function generateEncKey(length) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let result = '';
        for (let i = 0; i < length; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
        return result;
    }

    // Signup Handler
    document.getElementById('signupForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const loader = document.getElementById('signupLoader');
        loader.style.display = 'block';

        const email = document.getElementById('regEmail').value.toLowerCase();
        
        // 1. Check if user exists
        const userCheck = await db.collection('users').where('email', '==', email).get();
        if(!userCheck.empty) {
            alert('User with this email already exists.');
            loader.style.display = 'none';
            return;
        }

        // 2. Upload Profile Pic to Supabase
        const file = document.getElementById('profilePic').files[0];
        const fileName = `avatars/${Date.now()}_${file.name}`;
        
        // Assuming bucket 'files' exists. If not, this throws error.
        const { data: uploadData, error: uploadError } = await supabase.storage
            .from('files')
            .upload(fileName, file);

        if(uploadError) {
            console.error(uploadError);
            alert('Error uploading profile picture. Make sure bucket "files" exists.');
            loader.style.display = 'none';
            return;
        }

        const { data: publicUrlData } = supabase.storage.from('files').getPublicUrl(fileName);
        const profilePicUrl = publicUrlData.publicUrl;

        // 3. Create Data Object
        const encKey = generateEncKey(25);
        const userData = {
            fname: document.getElementById('fname').value,
            lname: document.getElementById('lname').value,
            dob: document.getElementById('dob').value,
            gender: document.getElementById('gender').value,
            email: email,
            password: document.getElementById('regPassword').value, // In real app, hash this!
            profilePic: profilePicUrl,
            encKey: encKey,
            createdAt: new Date().toISOString()
        };

        // 4. Save to Firestore
        try {
            await db.collection('users').add(userData);
            alert('Account created successfully! Please Login.');
            switchTab('login');
        } catch (error) {
            alert('Error creating account: ' + error.message);
        }
        loader.style.display = 'none';
    });

    // Login Handler
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const loader = document.getElementById('loginLoader');
        loader.style.display = 'block';

        const email = document.getElementById('loginEmail').value.toLowerCase();
        const password = document.getElementById('loginPassword').value;

        try {
            const snapshot = await db.collection('users')
                .where('email', '==', email)
                .where('password', '==', password)
                .get();

            if (snapshot.empty) {
                alert('Invalid Email or Password');
            } else {
                const user = snapshot.docs[0].data();
                // Store in LocalStorage for 2.html
                localStorage.setItem('xpertsUser', JSON.stringify(user));
                window.location.href = '2.html';
            }
        } catch (error) {
            console.error(error);
            alert('Login failed');
        }
        loader.style.display = 'none';
    });
</script>

</body>
</html>
