<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drive PDF Viewer</title>
    
    <!-- Google Fonts: Roboto (Google's standard font) -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --header-bg: #FFFFFF;
            --text-primary: #1F1F1F;
            --text-secondary: #444746;
            --viewer-bg: #F0F2F5; /* Drive grey background */
            --header-height: 64px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--viewer-bg);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Drive-like Header --- */
        header {
            height: var(--header-height);
            background: var(--header-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); /* Subtle shadow like Drive */
            z-index: 50;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
            overflow: hidden;
        }

        /* Material Design Icons styled buttons */
        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .icon-btn:hover { background-color: #f0f1f3; }
        .icon-btn:active { background-color: #e0e2e5; }

        .file-info {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .file-name {
            font-size: 1.1rem;
            color: var(--text-primary);
            font-weight: 400;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Share Button (Blue Pill style) */
        .share-pill {
            background-color: #C2E7FF;
            color: #001D35;
            border: none;
            padding: 8px 16px;
            border-radius: 24px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }
        .share-pill:hover { background-color: #b3dffc; }

        /* --- Viewer Area --- */
        main {
            flex: 1;
            position: relative;
            background: #525659; /* Standard PDF reader dark grey */
            width: 100%;
            height: calc(100vh - var(--header-height));
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        /* --- Loading / Overlay --- */
        #loader {
            position: absolute;
            top: var(--header-height);
            left: 0;
            width: 100%;
            height: calc(100vh - var(--header-height));
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 40;
        }

        /* Google-colored spinner */
        .spinner {
            width: 48px;
            height: 48px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4285F4; /* Google Blue */
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 20px;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Toast --- */
        #toast {
            position: fixed;
            bottom: 24px;
            left: 24px; /* Desktop left alignment like Drive web */
            background: #323232;
            color: white;
            padding: 14px 24px;
            border-radius: 4px;
            font-size: 0.9rem;
            box-shadow: 0 4px 5px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            z-index: 100;
            pointer-events: none;
        }
        @media (max-width: 600px) {
            #toast { left: 50%; transform: translateX(-50%) translateY(20px); border-radius: 24px; }
            #toast.show { transform: translateX(-50%) translateY(0); }
        }
        #toast.show { opacity: 1; transform: translateY(0); }

    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="header-left">
            <button class="icon-btn" onclick="history.back()" title="Go Back">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            <div class="file-info">
                <div class="file-name" id="doc-title">Document.pdf</div>
            </div>
        </div>
        <div class="header-right">
            <!-- Share Button -->
            <button class="share-pill" onclick="shareUrl()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M15 8c0-2.21-1.79-4-4-4S7 5.79 7 8c0 1.66 1.02 3.08 2.45 3.73-.25.22-.52.42-.81.58C6.96 13.2 2 14.07 2 18v2h18v-2c0-3.93-4.96-4.8-6.64-5.69.29-.16.56-.36.81-.58C13.98 11.08 15 9.66 15 8zm3 4v3h3v2h-3v3h-2v-3h-3v-2h3v-3h2z"/></svg>
                <span>Share</span>
            </button>
            
            <!-- Context Menu Icon (Visual only for now) -->
            <button class="icon-btn mobile-hide">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
            </button>
        </div>
    </header>

    <!-- Loader -->
    <div id="loader">
        <div class="spinner"></div>
        <div class="loading-text" id="status-text">Opening Document...</div>
    </div>

    <!-- Main PDF Container -->
    <main id="main-container">
        <!-- iframe injected via JS -->
    </main>

    <!-- Toast -->
    <div id="toast">Link copied to clipboard</div>

    <script>
        // --- 1. Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDL7sPp-FkG59L-mRQ7BrCGgeKMhQC80iw",
            authDomain: "xperts-metadata.firebaseapp.com",
            projectId: "xperts-metadata",
            storageBucket: "xperts-metadata.firebasestorage.app",
            messagingSenderId: "514845910910",
            appId: "1:514845910910:web:5a2402130a97b5d749b52f",
            measurementId: "G-CQ5KWGJSZB"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const COLLECTION = "pdf_shares";

        // --- 2. Utilities ---
        
        // Generate a 15-char ID
        function generateId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 15; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
            return result;
        }

        // Extract filename from URL for the header
        function getFileName(url) {
            try {
                const urlObj = new URL(url);
                const path = urlObj.pathname;
                const name = path.substring(path.lastIndexOf('/') + 1);
                return name.length > 20 ? name.substring(0, 20) + '...' : (name || 'Document.pdf');
            } catch (e) {
                return 'Document.pdf';
            }
        }

        // Show Toast Notification
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // Share functionality
        function shareUrl() {
            navigator.clipboard.writeText(window.location.href)
                .then(() => showToast("Link copied to clipboard"))
                .catch(() => showToast("Failed to copy link"));
        }

        // --- 3. Viewer Logic ---

        // This renders the PDF using Google Docs Viewer (The "Drive" look)
        function renderViewer(pdfUrl) {
            const container = document.getElementById('main-container');
            const loader = document.getElementById('loader');
            
            // Set Title
            document.getElementById('doc-title').textContent = getFileName(pdfUrl);

            // Construct Google Docs Viewer URL
            // embedded=true gives the "Drive" player
            const driveViewerUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(pdfUrl)}&embedded=true`;

            const iframe = document.createElement('iframe');
            iframe.src = driveViewerUrl;
            iframe.onload = () => {
                // Smooth fade out of loader
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 300);
            };

            container.innerHTML = '';
            container.appendChild(iframe);

            // Fallback timeout: Google Viewer sometimes loads without triggering onload events properly
            setTimeout(() => {
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 300);
            }, 2000);
        }

        // --- 4. Main Execution ---

        async function init() {
            const params = new URLSearchParams(window.location.search);
            const inputParam = params.get('file');

            if (!inputParam) {
                document.getElementById('status-text').textContent = "No file specified.";
                return;
            }

            // Detect if input is a URL or a Code
            const isUrl = inputParam.match(/^(http|https):\/\//);

            if (isUrl) {
                // SCENARIO: User provided a RAW URL
                // Action: Check DB -> Get Code -> Redirect -> Render
                
                try {
                    const q = await db.collection(COLLECTION).where('url', '==', inputParam).limit(1).get();
                    
                    let finalCode;

                    if (!q.empty) {
                        // Found existing
                        finalCode = q.docs[0].data().code;
                    } else {
                        // Create new (Never expires)
                        finalCode = generateId();
                        await db.collection(COLLECTION).doc(finalCode).set({
                            code: finalCode,
                            url: inputParam,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }

                    // Mask URL in browser
                    const newUrl = `${window.location.pathname}?file=${finalCode}`;
                    window.history.replaceState({path: newUrl}, '', newUrl);

                    // Render
                    renderViewer(inputParam);

                } catch (e) {
                    console.error("DB Error", e);
                    // Fallback: Render anyway if DB fails
                    renderViewer(inputParam);
                }

            } else {
                // SCENARIO: User provided a CODE
                // Action: Fetch URL -> Render
                
                try {
                    const doc = await db.collection(COLLECTION).doc(inputParam).get();
                    
                    if (doc.exists) {
                        const data = doc.data();
                        renderViewer(data.url);
                    } else {
                        document.getElementById('status-text').textContent = "File not found.";
                    }
                } catch (e) {
                    document.getElementById('status-text').textContent = "Error loading file.";
                }
            }
        }

        window.onload = init;

    </script>
</body>
</html>